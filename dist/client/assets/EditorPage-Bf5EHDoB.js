import{c as g,R as w,u as W,j as e,B as v,A as q,a as F,S as R,L as H,b as U,C as G,F as K,d as j,r as f,T,X as J,D as Y,e as X,f as Q,g as Z,h as S,I as E,i as ee,k as te,l as se}from"./index-B_hS8NaL.js";import{D as I,b as C,a as ne,P as oe,I as ae,C as ce,g as V,F as re}from"./index-C03HvIOw.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M17 18H3",key:"1amg6g"}],["path",{d:"M21 6H3",key:"1jwq7v"}]],le=g("AlignLeft",ie);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],ue=g("ArrowDown",de);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]],xe=g("ArrowUp",me);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],he=g("CircleCheckBig",pe);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],O=g("Copy",fe);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]],ye=g("GripVertical",ge);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]],ke=g("Hash",be);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=[["path",{d:"M6 12h12",key:"8npq4p"}],["path",{d:"M6 20V4",key:"1w1bmo"}],["path",{d:"M18 20V4",key:"o2hl4u"}]],je=g("Heading",ve);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]],we=g("ListChecks",Ne);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M5 12h14",key:"1ays0h"}]],Be=g("Minus",Ce);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]],Ie=g("Table",Se);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]],_e=g("Type",De),$=s=>{let a;const o=new Set,n=(u,i)=>{const h=typeof u=="function"?u(a):u;if(!Object.is(h,a)){const y=a;a=i??(typeof h!="object"||h===null)?h:Object.assign({},a,h),o.forEach(k=>k(a,y))}},t=()=>a,r={setState:n,getState:t,getInitialState:()=>d,subscribe:u=>(o.add(u),()=>o.delete(u))},d=a=s(n,t,r);return r},Me=(s=>s?$(s):$),Ee=s=>s;function $e(s,a=Ee){const o=w.useSyncExternalStore(s.subscribe,w.useCallback(()=>a(s.getState()),[s,a]),w.useCallback(()=>a(s.getInitialState()),[s,a]));return w.useDebugValue(o),o}const A=s=>{const a=Me(s),o=n=>$e(a,n);return Object.assign(o,a),o},Ae=(s=>s?A(s):A);function Pe(s,a,o){const n={...s},t=a.split(".");let c=n;for(let r=0;r<t.length-1;r++){const d=t[r],u=t[r+1],i=u!=null&&/^\d+$/.test(u);Array.isArray(c[d])?c[d]=[...c[d]]:typeof c[d]=="object"&&c[d]!==null?c[d]={...c[d]}:c[d]=i?[]:{},c=c[d]}const l=t[t.length-1];return l!=null&&(c[l]=o),n}function P(s,a){const o=s.replace(/_/g,"_"),n=a.filter(c=>c.type===s).map(c=>{const r=(c.config.key||"").match(new RegExp(`^${o}_(\\d+)$`));return(r==null?void 0:r[1])!=null?parseInt(r[1],10):0}),t=n.length>0?Math.max(...n):0;return`${o}_${t+1}`}function z(){return crypto.randomUUID()}const x=Ae((s,a)=>({blocks:[],pageConfig:{...I},selectedBlockId:null,isDirty:!1,versionId:null,modeloId:null,loadSchema:(o,n,t)=>{s({blocks:o.blocks||[],pageConfig:o.pageConfig||{...I},selectedBlockId:null,isDirty:!1,versionId:t,modeloId:n})},addBlock:(o,n)=>{const t=C[o];if(!t)return;const{blocks:c}=a(),l={...t.defaultConfig};t.hasData&&(l.key=P(o,c));const r={id:z(),type:o,config:l},d=[...c];n!==void 0&&n>=0&&n<=c.length?d.splice(n,0,r):d.push(r),s({blocks:d,isDirty:!0,selectedBlockId:r.id})},removeBlock:o=>{const{blocks:n,selectedBlockId:t}=a();s({blocks:n.filter(c=>c.id!==o),isDirty:!0,selectedBlockId:t===o?null:t})},duplicateBlock:o=>{const{blocks:n}=a(),t=n.findIndex(i=>i.id===o);if(t===-1)return;const c=n[t],l=C[c.type],r=JSON.parse(JSON.stringify(c.config));l!=null&&l.hasData&&r.key&&(r.key=P(c.type,n));const d={id:z(),type:c.type,config:r},u=[...n];u.splice(t+1,0,d),s({blocks:u,isDirty:!0,selectedBlockId:d.id})},moveBlock:(o,n)=>{const{blocks:t}=a(),c=t.findIndex(i=>i.id===o);if(c===-1)return;const l=n==="up"?c-1:c+1;if(l<0||l>=t.length)return;const r=[...t],d=r[c],u=r[l];r[c]=u,r[l]=d,s({blocks:r,isDirty:!0})},reorderBlocks:o=>{const{blocks:n}=a(),t=new Map(n.map(r=>[r.id,r])),c=o.map(r=>t.get(r)).filter(Boolean),l=n.filter(r=>!o.includes(r.id));s({blocks:[...c,...l],isDirty:!0})},updateBlockConfig:(o,n,t)=>{const{blocks:c}=a();s({blocks:c.map(l=>l.id===o?{...l,config:Pe(l.config,n,t)}:l),isDirty:!0})},selectBlock:o=>{s({selectedBlockId:o})},updatePageConfig:o=>{const{pageConfig:n}=a();s({pageConfig:{...n,...o},isDirty:!0})},getSchema:()=>{const{blocks:o,pageConfig:n}=a();return{blocks:o,pageConfig:n}},markClean:()=>{s({isDirty:!1})},reset:()=>{s({blocks:[],pageConfig:{...I},selectedBlockId:null,isDirty:!1,versionId:null,modeloId:null})}}));function ze({modeloNombre:s,versionNumero:a,estado:o,isSaving:n,onSave:t,onOpenPageConfig:c}){const l=W(),r=x(i=>i.isDirty),u={borrador:{label:"Borrador",className:"bg-yellow-100 text-yellow-800"},activo:{label:"Activo",className:"bg-green-100 text-green-800"},obsoleto:{label:"Obsoleto",className:"bg-gray-100 text-gray-600"}}[o]??{label:"Borrador",className:"bg-yellow-100 text-yellow-800"};return e.jsxs("div",{className:"flex h-14 items-center justify-between border-b bg-background px-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>l("/modelos"),title:"Volver a modelos",children:e.jsx(q,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:s}),e.jsxs("span",{className:"text-muted-foreground",children:["v",a]}),e.jsx(F,{className:u.className,children:u.label}),r&&e.jsx("span",{className:"text-xs text-amber-600 font-medium",children:"Sin guardar"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(v,{variant:"outline",size:"sm",onClick:c,children:[e.jsx(R,{className:"h-4 w-4 mr-1"}),"Pagina"]}),e.jsxs(v,{size:"sm",onClick:t,disabled:n||!r,children:[n?e.jsx(H,{className:"h-4 w-4 animate-spin mr-1"}):e.jsx(U,{className:"h-4 w-4 mr-1"}),"Guardar"]})]})]})}const Le={FileText:K,Heading:je,Minus:Be,Type:_e,Hash:ke,Calendar:ce,AlignLeft:le,ChevronDown:G,CheckCircle:he,ListChecks:we,Table:Ie,Image:ae,Pen:oe};function He(){const s=x(a=>a.addBlock);return e.jsxs("div",{className:"flex w-56 flex-col border-r bg-background overflow-y-auto",children:[e.jsx("div",{className:"px-4 py-3 border-b",children:e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground uppercase tracking-wide",children:"Bloques"})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-4",children:ne.map(a=>e.jsxs("div",{children:[e.jsx("p",{className:"px-2 pb-1 text-xs font-medium text-muted-foreground uppercase tracking-wide",children:a.label}),e.jsx("div",{className:"space-y-0.5",children:a.types.map(o=>{const n=C[o],t=Le[n.icon];return e.jsxs("button",{onClick:()=>s(o),className:j("flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm","hover:bg-accent hover:text-accent-foreground transition-colors","cursor-pointer select-none"),title:`Anadir ${n.label}`,children:[t&&e.jsx(t,{className:"h-4 w-4 shrink-0 text-muted-foreground"}),e.jsx("span",{className:"truncate",children:n.label})]},o)})})]},a.id))})]})}const D=794,L=1123,Te=new Set(["header","section_title","divider","tristate","checklist","table"]);function Ve(s){if(Te.has(s.type))return"w-full";const a=s.config.width||"full";return re[a]||"w-full"}function Oe({block:s,index:a,totalBlocks:o}){const n=x(p=>p.selectedBlockId),t=x(p=>p.selectBlock),c=x(p=>p.removeBlock),l=x(p=>p.duplicateBlock),r=x(p=>p.moveBlock),d=n===s.id,u=V(s.type),i=Ve(s),h=i==="w-full",[y,k]=f.useState(!1);if(!u)return e.jsx("div",{className:j(i,"p-0.5"),children:e.jsxs("div",{className:"rounded border border-dashed border-destructive bg-destructive/5 p-4 text-sm text-destructive",children:["Bloque desconocido: ",s.type]})});const N=u.EditorPreview;return e.jsx("div",{className:j(i,"relative group"),style:{padding:"1px"},onMouseEnter:()=>k(!0),onMouseLeave:()=>k(!1),children:e.jsxs("div",{className:j("relative rounded-sm transition-all cursor-pointer",d&&"ring-2 ring-primary ring-offset-1",!d&&y&&"ring-1 ring-primary/30"),onClick:p=>{p.stopPropagation(),t(s.id)},children:[(y||d)&&e.jsxs("div",{className:j("absolute z-20 flex items-center gap-0.5 rounded-md border bg-background/95 shadow-sm backdrop-blur-sm px-1 py-0.5",h?"-top-7 right-2":"-top-7 left-1/2 -translate-x-1/2"),onClick:p=>p.stopPropagation(),children:[e.jsx("button",{className:"rounded p-1 hover:bg-accent text-muted-foreground disabled:opacity-30",onClick:()=>r(s.id,"up"),disabled:a===0,title:"Mover arriba",children:e.jsx(xe,{className:"h-3 w-3"})}),e.jsx("button",{className:"rounded p-1 text-muted-foreground cursor-grab",title:"Arrastrar",children:e.jsx(ye,{className:"h-3 w-3"})}),e.jsx("button",{className:"rounded p-1 hover:bg-accent text-muted-foreground disabled:opacity-30",onClick:()=>r(s.id,"down"),disabled:a===o-1,title:"Mover abajo",children:e.jsx(ue,{className:"h-3 w-3"})}),e.jsx("div",{className:"w-px h-4 bg-border mx-0.5"}),e.jsx("button",{className:"rounded p-1 hover:bg-accent text-muted-foreground",onClick:()=>l(s.id),title:"Duplicar",children:e.jsx(O,{className:"h-3 w-3"})}),e.jsx("button",{className:"rounded p-1 hover:bg-destructive/10 text-destructive",onClick:()=>c(s.id),title:"Eliminar",children:e.jsx(T,{className:"h-3 w-3"})})]}),e.jsx(N,{block:s,isSelected:d})]})})}function We(){const s=x(i=>i.blocks),a=x(i=>i.pageConfig),o=x(i=>i.selectBlock),n=f.useRef(null),[t,c]=f.useState(1),l=f.useCallback(()=>{if(!n.current)return;const h=n.current.clientWidth-80,y=Math.min(h/D,1);c(y)},[]);f.useEffect(()=>{l();const i=new ResizeObserver(l);return n.current&&i.observe(n.current),()=>i.disconnect()},[l]);const r=a.orientation==="portrait",d=r?D:L,u=r?L:D;return e.jsx("div",{ref:n,className:"flex-1 overflow-y-auto bg-muted/40 p-8",onClick:()=>o(null),children:e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"bg-white shadow-lg border relative",style:{width:d,minHeight:u,transform:`scale(${t})`,transformOrigin:"top center",marginBottom:`${(u*t-u)*-1}px`,padding:`${a.margins.top*3.78}px ${a.margins.right*3.78}px ${a.margins.bottom*3.78}px ${a.margins.left*3.78}px`,fontSize:`${a.fontSize}px`},children:[e.jsx("div",{className:"absolute left-0 right-0 border-t-2 border-dashed border-red-200 pointer-events-none z-20",style:{top:u},children:e.jsx("span",{className:"absolute right-2 -top-4 text-[10px] text-red-300 bg-white px-1",children:"Corte de pagina"})}),s.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-32 text-muted-foreground/50",children:[e.jsx("p",{className:"text-lg font-medium",children:"Canvas vacio"}),e.jsx("p",{className:"text-sm mt-1",children:"Haz clic en un bloque de la paleta para empezar"})]}):e.jsx("div",{className:"flex flex-wrap items-start pt-2",children:s.map((i,h)=>e.jsx(Oe,{block:i,index:h,totalBlocks:s.length},i.id))})]})})})}function qe(){const s=x(i=>i.selectedBlockId),a=x(i=>i.blocks),o=x(i=>i.selectBlock),n=x(i=>i.updateBlockConfig),t=x(i=>i.duplicateBlock),c=x(i=>i.removeBlock);if(!s)return e.jsx("div",{className:"flex w-80 flex-col border-l bg-background",children:e.jsx("div",{className:"flex flex-1 items-center justify-center p-4 text-sm text-muted-foreground",children:"Selecciona un bloque para configurarlo"})});const l=a.find(i=>i.id===s);if(!l)return null;const r=V(l.type),d=C[l.type];if(!r||!d)return null;const u=r.ConfigPanel;return e.jsxs("div",{className:"flex w-80 flex-col border-l bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-4 py-3",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"text-sm font-semibold",children:d.label})}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:()=>o(null),children:e.jsx(J,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsx(u,{block:l,onChange:(i,h)=>n(l.id,i,h)})}),e.jsxs("div",{className:"flex items-center gap-2 border-t px-4 py-3",children:[e.jsxs(v,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>t(l.id),children:[e.jsx(O,{className:"h-4 w-4 mr-1"}),"Duplicar"]}),e.jsxs(v,{variant:"outline",size:"sm",className:"flex-1 text-destructive hover:bg-destructive/10",onClick:()=>{c(l.id)},children:[e.jsx(T,{className:"h-4 w-4 mr-1"}),"Eliminar"]})]})]})}function Fe({open:s,onOpenChange:a}){const o=x(t=>t.pageConfig),n=x(t=>t.updatePageConfig);return e.jsx(Y,{open:s,onOpenChange:a,children:e.jsxs(X,{className:"sm:max-w-md",children:[e.jsx(Q,{children:e.jsx(Z,{children:"Configuracion de pagina"})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"Orientacion"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:`flex-1 rounded-md border px-3 py-2 text-sm ${o.orientation==="portrait"?"border-primary bg-primary/5 text-primary":"border-border hover:bg-accent"}`,onClick:()=>n({orientation:"portrait"}),children:"Vertical"}),e.jsx("button",{className:`flex-1 rounded-md border px-3 py-2 text-sm ${o.orientation==="landscape"?"border-primary bg-primary/5 text-primary":"border-border hover:bg-accent"}`,onClick:()=>n({orientation:"landscape"}),children:"Horizontal"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"Margenes (mm)"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:["top","right","bottom","left"].map(t=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground w-16 capitalize",children:t==="top"?"Arriba":t==="right"?"Derecha":t==="bottom"?"Abajo":"Izquierda"}),e.jsx(E,{type:"number",min:5,max:50,value:o.margins[t],onChange:c=>n({margins:{...o.margins,[t]:Math.max(5,Math.min(50,Number(c.target.value)||5))}}),className:"h-8 w-full"})]},t))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"Tamano de fuente base (px)"}),e.jsx(E,{type:"number",min:8,max:14,value:o.fontSize,onChange:t=>n({fontSize:Math.max(8,Math.min(14,Number(t.target.value)||10))}),className:"h-8"})]})]})]})})}function Ge(){var M;const{modeloId:s,versionId:a}=ee(),o=Number(s),n=Number(a),{data:t,isLoading:c}=te(o||void 0,n||void 0),l=se(o),r=x(m=>m.loadSchema),d=x(m=>m.getSchema),u=x(m=>m.markClean),i=x(m=>m.isDirty),h=x(m=>m.selectBlock),y=x(m=>m.reset),[k,N]=f.useState(!1),[p,_]=f.useState(!1);f.useEffect(()=>{if(t){const m=t.schema||{blocks:[],pageConfig:void 0};r({blocks:m.blocks||[],pageConfig:m.pageConfig||void 0},o,n)}},[t,o,n,r]),f.useEffect(()=>()=>y(),[y]);const B=f.useCallback(async()=>{if(!p){_(!0);try{const m=d();await l.mutateAsync({id:n,schema:m}),u()}catch(m){console.error("Error al guardar:",m)}finally{_(!1)}}},[p,d,l,n,u]);return f.useEffect(()=>{const m=b=>{if((b.ctrlKey||b.metaKey)&&b.key==="s"){b.preventDefault(),i&&B();return}if(b.key==="Escape"){h(null);return}};return window.addEventListener("keydown",m),()=>window.removeEventListener("keydown",m)},[i,B,h]),f.useEffect(()=>{const m=b=>{i&&(b.preventDefault(),b.returnValue="")};return window.addEventListener("beforeunload",m),()=>window.removeEventListener("beforeunload",m)},[i]),c||!t?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(H,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"flex h-screen flex-col overflow-hidden",children:[e.jsx(ze,{modeloNombre:((M=t.modeloComponente)==null?void 0:M.nombre)||"Template",versionNumero:t.version,estado:t.estado,isSaving:p,onSave:B,onOpenPageConfig:()=>N(!0)}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsx(He,{}),e.jsx(We,{}),e.jsx(qe,{})]}),e.jsx(Fe,{open:k,onOpenChange:N})]})}export{Ge as default};
