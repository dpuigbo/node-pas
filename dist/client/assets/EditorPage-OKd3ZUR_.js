import{c as f,R as v,u as O,j as e,B as b,A as R,a as W,S as G,L,b as U,C as F,F as K,d as H,r as g,T,P as J,X,D as Q,e as Y,f as Z,g as ee,h as C,I as _,i as se,k as te,l as ne}from"./index-Dh87A0z7.js";import{D as B,b as j,a as oe,P as ae,I as ce,C as re,g as V}from"./index-BW0H33ip.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M17 18H3",key:"1amg6g"}],["path",{d:"M21 6H3",key:"1jwq7v"}]],le=f("AlignLeft",ie);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],ue=f("ArrowDown",de);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]],pe=f("ArrowUp",me);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],he=f("CircleCheckBig",xe);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],q=f("Copy",ge);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]],ye=f("GripVertical",fe);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]],be=f("Hash",ke);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=[["path",{d:"M6 12h12",key:"8npq4p"}],["path",{d:"M6 20V4",key:"1w1bmo"}],["path",{d:"M18 20V4",key:"o2hl4u"}]],je=f("Heading",ve);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]],we=f("ListChecks",Ne);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M5 12h14",key:"1ays0h"}]],Be=f("Minus",Ce);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]],Se=f("Table",Ie);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]],Me=f("Type",De),E=o=>{let a;const n=new Set,t=(u,i)=>{const h=typeof u=="function"?u(a):u;if(!Object.is(h,a)){const y=a;a=i??(typeof h!="object"||h===null)?h:Object.assign({},a,h),n.forEach(m=>m(a,y))}},s=()=>a,r={setState:t,getState:s,getInitialState:()=>d,subscribe:u=>(n.add(u),()=>n.delete(u))},d=a=o(t,s,r);return r},_e=(o=>o?E(o):E),Ee=o=>o;function Pe(o,a=Ee){const n=v.useSyncExternalStore(o.subscribe,v.useCallback(()=>a(o.getState()),[o,a]),v.useCallback(()=>a(o.getInitialState()),[o,a]));return v.useDebugValue(n),n}const P=o=>{const a=_e(o),n=t=>Pe(a,t);return Object.assign(n,a),n},$e=(o=>o?P(o):P);function ze(o,a,n){const t={...o},s=a.split(".");let c=t;for(let r=0;r<s.length-1;r++){const d=s[r],u=s[r+1],i=u!=null&&/^\d+$/.test(u);Array.isArray(c[d])?c[d]=[...c[d]]:typeof c[d]=="object"&&c[d]!==null?c[d]={...c[d]}:c[d]=i?[]:{},c=c[d]}const l=s[s.length-1];return l!=null&&(c[l]=n),t}function $(o,a){const n=o.replace(/_/g,"_"),t=a.filter(c=>c.type===o).map(c=>{const r=(c.config.key||"").match(new RegExp(`^${n}_(\\d+)$`));return(r==null?void 0:r[1])!=null?parseInt(r[1],10):0}),s=t.length>0?Math.max(...t):0;return`${n}_${s+1}`}function z(){return crypto.randomUUID()}const x=$e((o,a)=>({blocks:[],pageConfig:{...B},selectedBlockId:null,isDirty:!1,versionId:null,modeloId:null,loadSchema:(n,t,s)=>{o({blocks:n.blocks||[],pageConfig:n.pageConfig||{...B},selectedBlockId:null,isDirty:!1,versionId:s,modeloId:t})},addBlock:(n,t)=>{const s=j[n];if(!s)return;const{blocks:c}=a(),l={...s.defaultConfig};s.hasData&&(l.key=$(n,c));const r={id:z(),type:n,config:l},d=[...c];t!==void 0&&t>=0&&t<=c.length?d.splice(t,0,r):d.push(r),o({blocks:d,isDirty:!0,selectedBlockId:r.id})},removeBlock:n=>{const{blocks:t,selectedBlockId:s}=a();o({blocks:t.filter(c=>c.id!==n),isDirty:!0,selectedBlockId:s===n?null:s})},duplicateBlock:n=>{const{blocks:t}=a(),s=t.findIndex(i=>i.id===n);if(s===-1)return;const c=t[s],l=j[c.type],r=JSON.parse(JSON.stringify(c.config));l!=null&&l.hasData&&r.key&&(r.key=$(c.type,t));const d={id:z(),type:c.type,config:r},u=[...t];u.splice(s+1,0,d),o({blocks:u,isDirty:!0,selectedBlockId:d.id})},moveBlock:(n,t)=>{const{blocks:s}=a(),c=s.findIndex(i=>i.id===n);if(c===-1)return;const l=t==="up"?c-1:c+1;if(l<0||l>=s.length)return;const r=[...s],d=r[c],u=r[l];r[c]=u,r[l]=d,o({blocks:r,isDirty:!0})},reorderBlocks:n=>{const{blocks:t}=a(),s=new Map(t.map(r=>[r.id,r])),c=n.map(r=>s.get(r)).filter(Boolean),l=t.filter(r=>!n.includes(r.id));o({blocks:[...c,...l],isDirty:!0})},updateBlockConfig:(n,t,s)=>{const{blocks:c}=a();o({blocks:c.map(l=>l.id===n?{...l,config:ze(l.config,t,s)}:l),isDirty:!0})},selectBlock:n=>{o({selectedBlockId:n})},updatePageConfig:n=>{const{pageConfig:t}=a();o({pageConfig:{...t,...n},isDirty:!0})},getSchema:()=>{const{blocks:n,pageConfig:t}=a();return{blocks:n,pageConfig:t}},markClean:()=>{o({isDirty:!1})},reset:()=>{o({blocks:[],pageConfig:{...B},selectedBlockId:null,isDirty:!1,versionId:null,modeloId:null})}}));function Ae({modeloNombre:o,versionNumero:a,estado:n,isSaving:t,onSave:s,onOpenPageConfig:c}){const l=O(),r=x(i=>i.isDirty),u={borrador:{label:"Borrador",className:"bg-yellow-100 text-yellow-800"},activo:{label:"Activo",className:"bg-green-100 text-green-800"},obsoleto:{label:"Obsoleto",className:"bg-gray-100 text-gray-600"}}[n]??{label:"Borrador",className:"bg-yellow-100 text-yellow-800"};return e.jsxs("div",{className:"flex h-14 items-center justify-between border-b bg-background px-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>l("/modelos"),title:"Volver a modelos",children:e.jsx(R,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:o}),e.jsxs("span",{className:"text-muted-foreground",children:["v",a]}),e.jsx(W,{className:u.className,children:u.label}),r&&e.jsx("span",{className:"text-xs text-amber-600 font-medium",children:"Sin guardar"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:c,children:[e.jsx(G,{className:"h-4 w-4 mr-1"}),"Pagina"]}),e.jsxs(b,{size:"sm",onClick:s,disabled:t||!r,children:[t?e.jsx(L,{className:"h-4 w-4 animate-spin mr-1"}):e.jsx(U,{className:"h-4 w-4 mr-1"}),"Guardar"]})]})]})}const Le={FileText:K,Heading:je,Minus:Be,Type:Me,Hash:be,Calendar:re,AlignLeft:le,ChevronDown:F,CheckCircle:he,ListChecks:we,Table:Se,Image:ce,Pen:ae};function He(){const o=x(a=>a.addBlock);return e.jsxs("div",{className:"flex w-56 flex-col border-r bg-background overflow-y-auto",children:[e.jsx("div",{className:"px-4 py-3 border-b",children:e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground uppercase tracking-wide",children:"Bloques"})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-4",children:oe.map(a=>e.jsxs("div",{children:[e.jsx("p",{className:"px-2 pb-1 text-xs font-medium text-muted-foreground uppercase tracking-wide",children:a.label}),e.jsx("div",{className:"space-y-0.5",children:a.types.map(n=>{const t=j[n],s=Le[t.icon];return e.jsxs("button",{onClick:()=>o(n),className:H("flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm","hover:bg-accent hover:text-accent-foreground transition-colors","cursor-pointer select-none"),title:`Anadir ${t.label}`,children:[s&&e.jsx(s,{className:"h-4 w-4 shrink-0 text-muted-foreground"}),e.jsx("span",{className:"truncate",children:t.label})]},n)})})]},a.id))})]})}const I=794,A=1123;function Te({block:o,index:a,totalBlocks:n}){const t=x(m=>m.selectedBlockId),s=x(m=>m.selectBlock),c=x(m=>m.removeBlock),l=x(m=>m.duplicateBlock),r=x(m=>m.moveBlock),d=t===o.id,u=V(o.type),[i,h]=g.useState(!1);if(!u)return e.jsxs("div",{className:"rounded border border-dashed border-destructive bg-destructive/5 p-4 text-sm text-destructive",children:["Bloque desconocido: ",o.type]});const y=u.EditorPreview;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:H("group relative rounded-sm transition-all",d&&"ring-2 ring-primary ring-offset-1",!d&&i&&"ring-1 ring-primary/30"),onClick:m=>{m.stopPropagation(),s(o.id)},onMouseEnter:()=>h(!0),onMouseLeave:()=>h(!1),children:[(i||d)&&e.jsxs("div",{className:"absolute -left-10 top-0 flex flex-col gap-0.5 z-10",children:[e.jsx("button",{className:"rounded p-1 hover:bg-accent text-muted-foreground",onClick:m=>{m.stopPropagation(),r(o.id,"up")},disabled:a===0,title:"Mover arriba",children:e.jsx(pe,{className:"h-3 w-3"})}),e.jsx("div",{className:"rounded p-1 text-muted-foreground cursor-grab",children:e.jsx(ye,{className:"h-3 w-3"})}),e.jsx("button",{className:"rounded p-1 hover:bg-accent text-muted-foreground",onClick:m=>{m.stopPropagation(),r(o.id,"down")},disabled:a===n-1,title:"Mover abajo",children:e.jsx(ue,{className:"h-3 w-3"})})]}),(i||d)&&e.jsxs("div",{className:"absolute -right-10 top-0 flex flex-col gap-0.5 z-10",children:[e.jsx("button",{className:"rounded p-1 hover:bg-accent text-muted-foreground",onClick:m=>{m.stopPropagation(),l(o.id)},title:"Duplicar",children:e.jsx(q,{className:"h-3 w-3"})}),e.jsx("button",{className:"rounded p-1 hover:bg-destructive/10 text-destructive",onClick:m=>{m.stopPropagation(),c(o.id)},title:"Eliminar",children:e.jsx(T,{className:"h-3 w-3"})})]}),e.jsx(y,{block:o,isSelected:d})]}),e.jsx("div",{className:"flex justify-center py-0.5 opacity-0 hover:opacity-100 transition-opacity",children:e.jsx("button",{className:"flex items-center gap-1 rounded-full bg-primary/10 px-2 py-0.5 text-xs text-primary hover:bg-primary/20 transition-colors",onClick:m=>{m.stopPropagation()},title:"Insertar bloque aqui",children:e.jsx(J,{className:"h-3 w-3"})})})]})}function Ve(){const o=x(i=>i.blocks),a=x(i=>i.pageConfig),n=x(i=>i.selectBlock),t=g.useRef(null),[s,c]=g.useState(1),l=g.useCallback(()=>{if(!t.current)return;const h=t.current.clientWidth-120,y=Math.min(h/I,1);c(y)},[]);g.useEffect(()=>{l();const i=new ResizeObserver(l);return t.current&&i.observe(t.current),()=>i.disconnect()},[l]);const r=a.orientation==="portrait",d=r?I:A,u=r?A:I;return e.jsx("div",{ref:t,className:"flex-1 overflow-y-auto bg-muted/40 p-8",onClick:()=>n(null),children:e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"bg-white shadow-lg border relative",style:{width:d,minHeight:u,transform:`scale(${s})`,transformOrigin:"top center",marginBottom:`${(u*s-u)*-1}px`,padding:`${a.margins.top*3.78}px ${a.margins.right*3.78}px ${a.margins.bottom*3.78}px ${a.margins.left*3.78}px`,fontSize:`${a.fontSize}px`},children:[e.jsx("div",{className:"absolute left-0 right-0 border-t-2 border-dashed border-red-200 pointer-events-none z-20",style:{top:u},children:e.jsx("span",{className:"absolute right-2 -top-4 text-[10px] text-red-300 bg-white px-1",children:"Corte de pagina"})}),o.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-32 text-muted-foreground/50",children:[e.jsx("p",{className:"text-lg font-medium",children:"Canvas vacio"}),e.jsx("p",{className:"text-sm mt-1",children:"Haz clic en un bloque de la paleta para empezar"})]}):e.jsx("div",{className:"space-y-0",children:o.map((i,h)=>e.jsx(Te,{block:i,index:h,totalBlocks:o.length},i.id))})]})})})}function qe(){const o=x(i=>i.selectedBlockId),a=x(i=>i.blocks),n=x(i=>i.selectBlock),t=x(i=>i.updateBlockConfig),s=x(i=>i.duplicateBlock),c=x(i=>i.removeBlock);if(!o)return e.jsx("div",{className:"flex w-80 flex-col border-l bg-background",children:e.jsx("div",{className:"flex flex-1 items-center justify-center p-4 text-sm text-muted-foreground",children:"Selecciona un bloque para configurarlo"})});const l=a.find(i=>i.id===o);if(!l)return null;const r=V(l.type),d=j[l.type];if(!r||!d)return null;const u=r.ConfigPanel;return e.jsxs("div",{className:"flex w-80 flex-col border-l bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-4 py-3",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"text-sm font-semibold",children:d.label})}),e.jsx(b,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:()=>n(null),children:e.jsx(X,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsx(u,{block:l,onChange:(i,h)=>t(l.id,i,h)})}),e.jsxs("div",{className:"flex items-center gap-2 border-t px-4 py-3",children:[e.jsxs(b,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>s(l.id),children:[e.jsx(q,{className:"h-4 w-4 mr-1"}),"Duplicar"]}),e.jsxs(b,{variant:"outline",size:"sm",className:"flex-1 text-destructive hover:bg-destructive/10",onClick:()=>{c(l.id)},children:[e.jsx(T,{className:"h-4 w-4 mr-1"}),"Eliminar"]})]})]})}function Oe({open:o,onOpenChange:a}){const n=x(s=>s.pageConfig),t=x(s=>s.updatePageConfig);return e.jsx(Q,{open:o,onOpenChange:a,children:e.jsxs(Y,{className:"sm:max-w-md",children:[e.jsx(Z,{children:e.jsx(ee,{children:"Configuracion de pagina"})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Orientacion"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:`flex-1 rounded-md border px-3 py-2 text-sm ${n.orientation==="portrait"?"border-primary bg-primary/5 text-primary":"border-border hover:bg-accent"}`,onClick:()=>t({orientation:"portrait"}),children:"Vertical"}),e.jsx("button",{className:`flex-1 rounded-md border px-3 py-2 text-sm ${n.orientation==="landscape"?"border-primary bg-primary/5 text-primary":"border-border hover:bg-accent"}`,onClick:()=>t({orientation:"landscape"}),children:"Horizontal"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Margenes (mm)"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:["top","right","bottom","left"].map(s=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground w-16 capitalize",children:s==="top"?"Arriba":s==="right"?"Derecha":s==="bottom"?"Abajo":"Izquierda"}),e.jsx(_,{type:"number",min:5,max:50,value:n.margins[s],onChange:c=>t({margins:{...n.margins,[s]:Math.max(5,Math.min(50,Number(c.target.value)||5))}}),className:"h-8 w-full"})]},s))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Tamano de fuente base (px)"}),e.jsx(_,{type:"number",min:8,max:14,value:n.fontSize,onChange:s=>t({fontSize:Math.max(8,Math.min(14,Number(s.target.value)||10))}),className:"h-8"})]})]})]})})}function Ge(){var M;const{modeloId:o,versionId:a}=se(),n=Number(o),t=Number(a),{data:s,isLoading:c}=te(n||void 0,t||void 0),l=ne(n),r=x(p=>p.loadSchema),d=x(p=>p.getSchema),u=x(p=>p.markClean),i=x(p=>p.isDirty),h=x(p=>p.selectBlock),y=x(p=>p.reset),[m,S]=g.useState(!1),[N,D]=g.useState(!1);g.useEffect(()=>{if(s){const p=s.schema||{blocks:[],pageConfig:void 0};r({blocks:p.blocks||[],pageConfig:p.pageConfig||void 0},n,t)}},[s,n,t,r]),g.useEffect(()=>()=>y(),[y]);const w=g.useCallback(async()=>{if(!N){D(!0);try{const p=d();await l.mutateAsync({id:t,schema:p}),u()}catch(p){console.error("Error al guardar:",p)}finally{D(!1)}}},[N,d,l,t,u]);return g.useEffect(()=>{const p=k=>{if((k.ctrlKey||k.metaKey)&&k.key==="s"){k.preventDefault(),i&&w();return}if(k.key==="Escape"){h(null);return}};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[i,w,h]),g.useEffect(()=>{const p=k=>{i&&(k.preventDefault(),k.returnValue="")};return window.addEventListener("beforeunload",p),()=>window.removeEventListener("beforeunload",p)},[i]),c||!s?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(L,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"flex h-screen flex-col overflow-hidden",children:[e.jsx(Ae,{modeloNombre:((M=s.modeloComponente)==null?void 0:M.nombre)||"Template",versionNumero:s.version,estado:s.estado,isSaving:N,onSave:w,onOpenPageConfig:()=>S(!0)}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsx(He,{}),e.jsx(Ve,{}),e.jsx(qe,{})]}),e.jsx(Oe,{open:m,onOpenChange:S})]})}export{Ge as default};
