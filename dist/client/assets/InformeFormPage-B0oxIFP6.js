import{c as w,i as E,u as z,m as A,r as h,j as e,B as y,A as k,a as F,L as C,b as B}from"./index-BbT_qP1u.js";import{a as P,b as I,c as L}from"./useInformes-0mmmw-9f.js";import{g as _}from"./index-BhO1s0NE.js";import{C as D}from"./circle-alert-BV4KW8Yv.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],O=w("CircleCheck",T);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],U=w("Circle",R),$={borrador:"bg-gray-100 text-gray-700",finalizado:"bg-amber-100 text-amber-700",entregado:"bg-green-100 text-green-700"},M={borrador:"Borrador",finalizado:"Finalizado",entregado:"Entregado"},q=new Set(["header","section_title","divider"]);function X(){var N;const{id:t}=E(),l=Number(t),i=z(),{isAdmin:x}=A(),{data:s,isLoading:n}=P(l||void 0),[o,r]=h.useState(0),[u,g]=h.useState({}),b=h.useMemo(()=>{const c=new Set;if(!s)return c;for(const d of s.componentes)u[d.id]&&c.add(d.id);return c},[s,u]),a=(N=s==null?void 0:s.componentes)==null?void 0:N[o],m=(s==null?void 0:s.estado)!=="borrador",p=h.useMemo(()=>a?{...a.datos,...u[a.id]??{}}:{},[a,u]),f=h.useCallback((c,d)=>{!a||m||g(j=>({...j,[a.id]:{...j[a.id]??{},[c]:d}}))},[a,m]);if(n)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})});if(!s)return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(D,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Informe no encontrado"}),e.jsx(y,{variant:"outline",onClick:()=>i(-1),children:"Volver"})]});const v=s.componentes;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(y,{variant:"ghost",size:"icon",onClick:()=>i(`/intervenciones/${s.intervencionId}`),children:e.jsx(k,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-lg font-semibold truncate",children:s.sistema.nombre}),e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[s.intervencion.titulo," —"," ",s.sistema.fabricante.nombre]})]}),e.jsx(F,{className:$[s.estado]??"bg-gray-100 text-gray-700",children:M[s.estado]??s.estado})]}),v.length>1&&e.jsx("div",{className:"flex gap-1 overflow-x-auto border-b pb-1",children:v.map((c,d)=>{const j=d===o,S=b.has(c.id);return e.jsxs("button",{type:"button",onClick:()=>r(d),className:`relative flex items-center gap-1.5 whitespace-nowrap rounded-t px-3 py-2 text-sm font-medium transition-colors ${j?"bg-white border border-b-white text-primary shadow-sm -mb-px":"text-muted-foreground hover:text-foreground hover:bg-gray-50"}`,children:[S&&e.jsx(U,{className:"h-2 w-2 fill-amber-500 text-amber-500"}),c.etiqueta]},c.id)})}),a&&e.jsx(G,{componente:a,datos:p,readOnly:m,onFieldChange:f,informeId:l,localDatos:u[a.id],onSaved:()=>g(c=>{const d={...c};return delete d[a.id],d})},a.id),x&&s.estado==="borrador"&&e.jsx("div",{className:"flex justify-end border-t pt-4",children:e.jsx(V,{informeId:l,intervencionId:s.intervencionId})})]})}function G({componente:t,datos:l,readOnly:i,onFieldChange:x,informeId:s,localDatos:n,onSaved:o}){var a;const r=I(t.id,s),u=!!n&&Object.keys(n).length>0,g=async()=>{var m,p;if(!(!n||!u))try{await r.mutateAsync(n),o()}catch(f){const v=((p=(m=f==null?void 0:f.response)==null?void 0:m.data)==null?void 0:p.error)??"Error al guardar";alert(v)}},b=((a=t.schemaCongelado)==null?void 0:a.blocks)??[];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-medium",children:t.etiqueta}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.componenteSistema.modeloComponente.nombre,t.componenteSistema.numeroSerie&&` · S/N: ${t.componenteSistema.numeroSerie}`]})]}),!i&&e.jsxs(y,{size:"sm",onClick:g,disabled:!u||r.isPending,className:"gap-1",children:[r.isPending?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(B,{className:"h-4 w-4"}),"Guardar"]})]}),e.jsx("div",{className:"space-y-4",children:b.map(m=>e.jsx(K,{block:m,datos:l,readOnly:i,onFieldChange:x},m.id))})]})}function K({block:t,datos:l,readOnly:i,onFieldChange:x}){const s=_(t.type);if(!s)return null;if(q.has(t.type)){const r=s.EditorPreview;return e.jsx("div",{className:"pointer-events-none",children:e.jsx(r,{block:t,isSelected:!1})})}const n=t.config.key;if(!n)return null;const o=s.FormField;if(!o){const r=s.EditorPreview;return e.jsx("div",{className:"pointer-events-none opacity-70",children:e.jsx(r,{block:t,isSelected:!1})})}return e.jsx(o,{block:t,value:l[n]??null,onChange:r=>x(n,r),readOnly:i})}function V({informeId:t,intervencionId:l}){const i=L(t,l),x=async()=>{var s,n;if(window.confirm("Una vez finalizado, los datos del informe no se podran modificar. ¿Continuar?"))try{await i.mutateAsync("finalizado")}catch(o){const r=((n=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:n.error)??"Error al finalizar";alert(r)}};return e.jsxs(y,{onClick:x,disabled:i.isPending,variant:"default",className:"gap-1",children:[i.isPending?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(O,{className:"h-4 w-4"}),"Finalizar informe"]})}export{X as default};
