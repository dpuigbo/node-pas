import{f as w,c as E,u as A,g as F,r as g,j as e,B as p,A as L,a as _,L as C,b as z}from"./index-L7yFcTJt.js";import{a as B,b as k,c as I}from"./useInformes-CF35Jt8c.js";import{g as P,B as $,F as D}from"./index-DzSgxc3a.js";import{C as T}from"./circle-alert-C3_HrdkD.js";import{E as O}from"./eye-CsJ_ohiK.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],R=w("CircleCheck",U);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],M=w("Circle",G),W={borrador:"bg-gray-100 text-gray-700",finalizado:"bg-amber-100 text-amber-700",entregado:"bg-green-100 text-green-700"},q={borrador:"Borrador",finalizado:"Finalizado",entregado:"Entregado"},K=new Set(["header","section_title","divider"]);function ae(){var b;const{id:t}=E(),r=Number(t),i=A(),{isAdmin:x}=F(),{data:s,isLoading:n}=B(r||void 0),[o,c]=g.useState(0),[d,m]=g.useState({}),N=g.useMemo(()=>{const l=new Set;if(!s)return l;for(const u of s.componentes)d[u.id]&&l.add(u.id);return l},[s,d]),a=(b=s==null?void 0:s.componentes)==null?void 0:b[o],f=(s==null?void 0:s.estado)!=="borrador",v=g.useMemo(()=>a?{...a.datos,...d[a.id]??{}}:{},[a,d]),h=g.useCallback((l,u)=>{!a||f||m(y=>({...y,[a.id]:{...y[a.id]??{},[l]:u}}))},[a,f]);if(n)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})});if(!s)return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(T,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Informe no encontrado"}),e.jsx(p,{variant:"outline",onClick:()=>i(-1),children:"Volver"})]});const j=s.componentes;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>i(`/intervenciones/${s.intervencionId}`),children:e.jsx(L,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-lg font-semibold truncate",children:s.sistema.nombre}),e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[s.intervencion.titulo," —"," ",s.sistema.fabricante.nombre]})]}),e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>i(`/informes/${r}/preview`),className:"gap-1",children:[e.jsx(O,{className:"h-4 w-4"}),"Vista documento"]}),e.jsx(_,{className:W[s.estado]??"bg-gray-100 text-gray-700",children:q[s.estado]??s.estado})]}),j.length>1&&e.jsx("div",{className:"flex gap-1 overflow-x-auto border-b pb-1",children:j.map((l,u)=>{const y=u===o,S=N.has(l.id);return e.jsxs("button",{type:"button",onClick:()=>c(u),className:`relative flex items-center gap-1.5 whitespace-nowrap rounded-t px-3 py-2 text-sm font-medium transition-colors ${y?"bg-white border border-b-white text-primary shadow-sm -mb-px":"text-muted-foreground hover:text-foreground hover:bg-gray-50"}`,children:[S&&e.jsx(M,{className:"h-2 w-2 fill-amber-500 text-amber-500"}),l.etiqueta]},l.id)})}),a&&e.jsx(V,{componente:a,datos:v,readOnly:f,onFieldChange:h,informeId:r,localDatos:d[a.id],onSaved:()=>m(l=>{const u={...l};return delete u[a.id],u})},a.id),x&&s.estado==="borrador"&&e.jsx("div",{className:"flex justify-end border-t pt-4",children:e.jsx(Q,{informeId:r,intervencionId:s.intervencionId})})]})}function V({componente:t,datos:r,readOnly:i,onFieldChange:x,informeId:s,localDatos:n,onSaved:o}){var a;const c=k(t.id,s),d=!!n&&Object.keys(n).length>0,m=async()=>{var f,v;if(!(!n||!d))try{await c.mutateAsync(n),o()}catch(h){const j=((v=(f=h==null?void 0:h.response)==null?void 0:f.data)==null?void 0:v.error)??"Error al guardar";alert(j)}},N=((a=t.schemaCongelado)==null?void 0:a.blocks)??[];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-medium",children:t.etiqueta}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.componenteSistema.modeloComponente.nombre,t.componenteSistema.numeroSerie&&` · S/N: ${t.componenteSistema.numeroSerie}`]})]}),!i&&e.jsxs(p,{size:"sm",onClick:m,disabled:!d||c.isPending,className:"gap-1",children:[c.isPending?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(z,{className:"h-4 w-4"}),"Guardar"]})]}),e.jsx("div",{className:"flex flex-wrap items-start gap-y-4",children:N.map(f=>e.jsx(J,{block:f,datos:r,readOnly:i,onFieldChange:x},f.id))})]})}const Y=new Set(["header","section_title","divider","tristate","checklist","table"]);function H(t){if(Y.has(t.type))return"w-full";const r=t.config.width||"full";return D[r]||"w-full"}function J({block:t,datos:r,readOnly:i,onFieldChange:x}){const s=P(t.type);if(!s)return null;const n=H(t),o=$[t.config.align||"left"];if(K.has(t.type)){const m=s.EditorPreview;return e.jsx("div",{className:`${n} ${o} pointer-events-none`,children:e.jsx(m,{block:t,isSelected:!1})})}const c=t.config.key;if(!c)return null;const d=s.FormField;if(!d){const m=s.EditorPreview;return e.jsx("div",{className:`${n} ${o} pointer-events-none opacity-70`,children:e.jsx(m,{block:t,isSelected:!1})})}return e.jsx("div",{className:`${n} ${o}`,children:e.jsx(d,{block:t,value:r[c]??null,onChange:m=>x(c,m),readOnly:i})})}function Q({informeId:t,intervencionId:r}){const i=I(t,r),x=async()=>{var s,n;if(window.confirm("Una vez finalizado, los datos del informe no se podran modificar. ¿Continuar?"))try{await i.mutateAsync("finalizado")}catch(o){const c=((n=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:n.error)??"Error al finalizar";alert(c)}};return e.jsxs(p,{onClick:x,disabled:i.isPending,variant:"default",className:"gap-1",children:[i.isPending?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(R,{className:"h-4 w-4"}),"Finalizar informe"]})}export{ae as default};
