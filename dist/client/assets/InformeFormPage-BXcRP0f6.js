import{c as N,i as E,u as F,m as A,r as h,j as e,B as y,A as z,a as L,L as C,b as _}from"./index-B_hS8NaL.js";import{a as k,b as B,c as I}from"./useInformes-DjpTkawZ.js";import{g as P,F as D}from"./index-C03HvIOw.js";import{C as T}from"./circle-alert-BJLYUIH_.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],U=N("CircleCheck",$);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],R=N("Circle",O),M={borrador:"bg-gray-100 text-gray-700",finalizado:"bg-amber-100 text-amber-700",entregado:"bg-green-100 text-green-700"},W={borrador:"Borrador",finalizado:"Finalizado",entregado:"Entregado"},q=new Set(["header","section_title","divider"]);function ee(){var w;const{id:s}=E(),o=Number(s),c=F(),{isAdmin:x}=A(),{data:t,isLoading:r}=k(o||void 0),[i,l]=h.useState(0),[n,g]=h.useState({}),b=h.useMemo(()=>{const d=new Set;if(!t)return d;for(const m of t.componentes)n[m.id]&&d.add(m.id);return d},[t,n]),a=(w=t==null?void 0:t.componentes)==null?void 0:w[i],u=(t==null?void 0:t.estado)!=="borrador",p=h.useMemo(()=>a?{...a.datos,...n[a.id]??{}}:{},[a,n]),f=h.useCallback((d,m)=>{!a||u||g(j=>({...j,[a.id]:{...j[a.id]??{},[d]:m}}))},[a,u]);if(r)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})});if(!t)return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(T,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Informe no encontrado"}),e.jsx(y,{variant:"outline",onClick:()=>c(-1),children:"Volver"})]});const v=t.componentes;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(y,{variant:"ghost",size:"icon",onClick:()=>c(`/intervenciones/${t.intervencionId}`),children:e.jsx(z,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-lg font-semibold truncate",children:t.sistema.nombre}),e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[t.intervencion.titulo," —"," ",t.sistema.fabricante.nombre]})]}),e.jsx(L,{className:M[t.estado]??"bg-gray-100 text-gray-700",children:W[t.estado]??t.estado})]}),v.length>1&&e.jsx("div",{className:"flex gap-1 overflow-x-auto border-b pb-1",children:v.map((d,m)=>{const j=m===i,S=b.has(d.id);return e.jsxs("button",{type:"button",onClick:()=>l(m),className:`relative flex items-center gap-1.5 whitespace-nowrap rounded-t px-3 py-2 text-sm font-medium transition-colors ${j?"bg-white border border-b-white text-primary shadow-sm -mb-px":"text-muted-foreground hover:text-foreground hover:bg-gray-50"}`,children:[S&&e.jsx(R,{className:"h-2 w-2 fill-amber-500 text-amber-500"}),d.etiqueta]},d.id)})}),a&&e.jsx(G,{componente:a,datos:p,readOnly:u,onFieldChange:f,informeId:o,localDatos:n[a.id],onSaved:()=>g(d=>{const m={...d};return delete m[a.id],m})},a.id),x&&t.estado==="borrador"&&e.jsx("div",{className:"flex justify-end border-t pt-4",children:e.jsx(V,{informeId:o,intervencionId:t.intervencionId})})]})}function G({componente:s,datos:o,readOnly:c,onFieldChange:x,informeId:t,localDatos:r,onSaved:i}){var a;const l=B(s.id,t),n=!!r&&Object.keys(r).length>0,g=async()=>{var u,p;if(!(!r||!n))try{await l.mutateAsync(r),i()}catch(f){const v=((p=(u=f==null?void 0:f.response)==null?void 0:u.data)==null?void 0:p.error)??"Error al guardar";alert(v)}},b=((a=s.schemaCongelado)==null?void 0:a.blocks)??[];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-medium",children:s.etiqueta}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.componenteSistema.modeloComponente.nombre,s.componenteSistema.numeroSerie&&` · S/N: ${s.componenteSistema.numeroSerie}`]})]}),!c&&e.jsxs(y,{size:"sm",onClick:g,disabled:!n||l.isPending,className:"gap-1",children:[l.isPending?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(_,{className:"h-4 w-4"}),"Guardar"]})]}),e.jsx("div",{className:"flex flex-wrap items-start gap-y-4",children:b.map(u=>e.jsx(K,{block:u,datos:o,readOnly:c,onFieldChange:x},u.id))})]})}const Y=new Set(["header","section_title","divider","tristate","checklist","table"]);function H(s){if(Y.has(s.type))return"w-full";const o=s.config.width||"full";return D[o]||"w-full"}function K({block:s,datos:o,readOnly:c,onFieldChange:x}){const t=P(s.type);if(!t)return null;const r=H(s);if(q.has(s.type)){const n=t.EditorPreview;return e.jsx("div",{className:`${r} pointer-events-none`,children:e.jsx(n,{block:s,isSelected:!1})})}const i=s.config.key;if(!i)return null;const l=t.FormField;if(!l){const n=t.EditorPreview;return e.jsx("div",{className:`${r} pointer-events-none opacity-70`,children:e.jsx(n,{block:s,isSelected:!1})})}return e.jsx("div",{className:r,children:e.jsx(l,{block:s,value:o[i]??null,onChange:n=>x(i,n),readOnly:c})})}function V({informeId:s,intervencionId:o}){const c=I(s,o),x=async()=>{var t,r;if(window.confirm("Una vez finalizado, los datos del informe no se podran modificar. ¿Continuar?"))try{await c.mutateAsync("finalizado")}catch(i){const l=((r=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:r.error)??"Error al finalizar";alert(l)}};return e.jsxs(y,{onClick:x,disabled:c.isPending,variant:"default",className:"gap-1",children:[c.isPending?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(U,{className:"h-4 w-4"}),"Finalizar informe"]})}export{ee as default};
