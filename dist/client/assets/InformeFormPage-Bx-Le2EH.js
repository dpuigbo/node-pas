import{f as B,c as O,u as P,g as $,Q as D,r as h,R as T,j as e,L as w,B as j,A as K,a as z,b as R}from"./index-C76Zc80P.js";import{a as U,b as G}from"./useInformes-BC_tZ1nV.js";import{g as V,B as q,F as Q}from"./index-Ch13Ujs8.js";import{A as W,D as M}from"./AssembledTableOfContents-bhDKTSCB.js";import{C as Y}from"./circle-alert-Bs5d4Wwy.js";import{E as H}from"./eye-CUvNwhTI.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],X=B("CircleCheck",J);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],ee=B("Circle",Z),se={borrador:"bg-gray-100 text-gray-700",finalizado:"bg-amber-100 text-amber-700",entregado:"bg-green-100 text-green-700"},ae={borrador:"Borrador",finalizado:"Finalizado",entregado:"Entregado"},ne=new Set(["header","section_title","divider","section_separator","tristate","checklist","table","equipment_exchange","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","intervention_data","client_data"]),te=new Set(["header","section_title","divider","section_separator","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","content_placeholder","intervention_data","client_data","component_section"]);function ge(){var A,F;const{id:s}=O(),r=Number(s),l=P(),{isAdmin:m}=$(),o=D(),{data:n,isLoading:d,error:i}=U(r||void 0),[t,c]=h.useState({}),[x,_]=h.useState(!1),p=((A=n==null?void 0:n.informe)==null?void 0:A.estado)!=="borrador",v=h.useMemo(()=>Object.values(t).some(a=>a&&Object.keys(a).length>0),[t]),y=h.useMemo(()=>Object.entries(t).filter(([,a])=>a&&Object.keys(a).length>0).map(([a])=>Number(a)),[t]),S=h.useCallback((a,b,u)=>{p||c(g=>({...g,[a]:{...g[a]??{},[b]:u}}))},[p]),L=h.useCallback(async()=>{var a,b;if(!(!v||x)){_(!0);try{const u=y.map(async g=>{const N=t[g];!N||Object.keys(N).length===0||await T.patch(`/v1/componentes-informe/${g}/datos`,{datos:N})});await Promise.all(u),c({}),o.invalidateQueries({queryKey:["informes",r,"assembled"]})}catch(u){const g=((b=(a=u==null?void 0:u.response)==null?void 0:a.data)==null?void 0:b.error)??"Error al guardar";alert(g)}finally{_(!1)}}},[v,x,y,t,o,r]),C=(F=n==null?void 0:n.assembled)==null?void 0:F.blocks,k=h.useCallback(a=>a.type==="table_of_contents"&&C?e.jsx("div",{className:"w-full pointer-events-none",children:e.jsx(W,{block:a,allBlocks:C})}):e.jsx(re,{block:a,localDatos:t,readOnly:p,onFieldChange:S}),[t,p,S,C]);if(d)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(w,{className:"h-8 w-8 animate-spin text-muted-foreground"})});if(i||!n)return e.jsxs("div",{className:"flex h-screen flex-col items-center justify-center gap-4",children:[e.jsx(Y,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:(i==null?void 0:i.message)||"No se pudo cargar el informe"}),e.jsx(j,{variant:"outline",onClick:()=>l(-1),children:"Volver"})]});const{informe:f,assembled:E,documentTemplate:I}=n;return e.jsxs("div",{className:"flex h-screen flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex h-14 items-center justify-between border-b bg-background px-4 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>l(`/intervenciones/${f.intervencion.id}`),title:"Volver a intervencion",children:e.jsx(K,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:f.sistema.nombre}),e.jsx(z,{className:"bg-blue-100 text-blue-800",children:I.nombre}),e.jsx(z,{className:se[f.estado]??"bg-gray-100 text-gray-700",children:ae[f.estado]??f.estado}),v&&e.jsxs("span",{className:"text-xs text-amber-600 font-medium",children:[e.jsx(ee,{className:"inline h-2 w-2 fill-amber-500 text-amber-500 mr-1"}),"Sin guardar"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>l(`/informes/${r}/preview`),className:"gap-1",children:[e.jsx(H,{className:"h-4 w-4"}),"Vista previa"]}),!p&&e.jsxs(j,{size:"sm",onClick:L,disabled:!v||x,className:"gap-1",children:[x?e.jsx(w,{className:"h-4 w-4 animate-spin"}):e.jsx(R,{className:"h-4 w-4"}),"Guardar",y.length>0&&` (${y.length})`]}),m&&f.estado==="borrador"&&e.jsx(oe,{informeId:r,intervencionId:f.intervencion.id,disabled:v})]})]}),e.jsx("div",{className:"flex-1 overflow-auto bg-gray-100",children:e.jsx("div",{className:"py-8 px-4",children:e.jsx(M,{blocks:E.blocks,pageConfig:E.pageConfig,renderBlock:k})})})]})}function re({block:s,localDatos:r,readOnly:l,onFieldChange:m}){const o=V(s.type);if(!o)return null;const n=ie(s),d=q[s.config.align||"left"];if(te.has(s.type)){const c=o.EditorPreview;return e.jsx("div",{className:`${n} ${d} pointer-events-none`,children:e.jsx(c,{block:s,isSelected:!1})})}const i=o.FormField;if(i&&s._dataKey&&s._componenteInformeId){const c=r[s._componenteInformeId],x=(c==null?void 0:c[s._dataKey])!==void 0?c[s._dataKey]:s._dataValue??null;return e.jsx("div",{className:`${n} ${d}`,children:e.jsx(i,{block:s,value:x,onChange:_=>m(s._componenteInformeId,s._dataKey,_),readOnly:l})})}const t=o.EditorPreview;return e.jsx("div",{className:`${n} ${d} pointer-events-none`,children:e.jsx(t,{block:s,isSelected:!1})})}function ie(s){if(ne.has(s.type))return"w-full";const r=s.config.width||"full";return Q[r]||"w-full"}function oe({informeId:s,intervencionId:r,disabled:l}){const m=G(s,r),o=async()=>{var n,d;if(window.confirm("Una vez finalizado, los datos del informe no se podran modificar. Â¿Continuar?"))try{await m.mutateAsync("finalizado")}catch(i){const t=((d=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:d.error)??"Error al finalizar";alert(t)}};return e.jsxs(j,{onClick:o,disabled:m.isPending||l,variant:"default",className:"gap-1",title:l?"Guarda los cambios antes de finalizar":void 0,children:[m.isPending?e.jsx(w,{className:"h-4 w-4 animate-spin"}):e.jsx(X,{className:"h-4 w-4"}),"Finalizar"]})}export{ge as default};
