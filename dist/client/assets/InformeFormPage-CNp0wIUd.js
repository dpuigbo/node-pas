import{f as w,c as A,u as E,g as F,r as g,j as e,B as y,A as L,a as _,L as C,b as z}from"./index-BC84jm5T.js";import{a as B,b as I,c as k}from"./useInformes-h3qlKdAF.js";import{g as P,B as $,F as D}from"./index-D-TgNxS8.js";import{C as T}from"./circle-alert-Bru0uTuU.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],U=w("CircleCheck",O);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],G=w("Circle",R),M={borrador:"bg-gray-100 text-gray-700",finalizado:"bg-amber-100 text-amber-700",entregado:"bg-green-100 text-green-700"},W={borrador:"Borrador",finalizado:"Finalizado",entregado:"Entregado"},q=new Set(["header","section_title","divider"]);function te(){var N;const{id:s}=A(),i=Number(s),o=E(),{isAdmin:x}=F(),{data:t,isLoading:n}=B(i||void 0),[r,c]=g.useState(0),[d,m]=g.useState({}),b=g.useMemo(()=>{const l=new Set;if(!t)return l;for(const u of t.componentes)d[u.id]&&l.add(u.id);return l},[t,d]),a=(N=t==null?void 0:t.componentes)==null?void 0:N[r],f=(t==null?void 0:t.estado)!=="borrador",p=g.useMemo(()=>a?{...a.datos,...d[a.id]??{}}:{},[a,d]),h=g.useCallback((l,u)=>{!a||f||m(j=>({...j,[a.id]:{...j[a.id]??{},[l]:u}}))},[a,f]);if(n)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})});if(!t)return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(T,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Informe no encontrado"}),e.jsx(y,{variant:"outline",onClick:()=>o(-1),children:"Volver"})]});const v=t.componentes;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(y,{variant:"ghost",size:"icon",onClick:()=>o(`/intervenciones/${t.intervencionId}`),children:e.jsx(L,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-lg font-semibold truncate",children:t.sistema.nombre}),e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[t.intervencion.titulo," —"," ",t.sistema.fabricante.nombre]})]}),e.jsx(_,{className:M[t.estado]??"bg-gray-100 text-gray-700",children:W[t.estado]??t.estado})]}),v.length>1&&e.jsx("div",{className:"flex gap-1 overflow-x-auto border-b pb-1",children:v.map((l,u)=>{const j=u===r,S=b.has(l.id);return e.jsxs("button",{type:"button",onClick:()=>c(u),className:`relative flex items-center gap-1.5 whitespace-nowrap rounded-t px-3 py-2 text-sm font-medium transition-colors ${j?"bg-white border border-b-white text-primary shadow-sm -mb-px":"text-muted-foreground hover:text-foreground hover:bg-gray-50"}`,children:[S&&e.jsx(G,{className:"h-2 w-2 fill-amber-500 text-amber-500"}),l.etiqueta]},l.id)})}),a&&e.jsx(K,{componente:a,datos:p,readOnly:f,onFieldChange:h,informeId:i,localDatos:d[a.id],onSaved:()=>m(l=>{const u={...l};return delete u[a.id],u})},a.id),x&&t.estado==="borrador"&&e.jsx("div",{className:"flex justify-end border-t pt-4",children:e.jsx(J,{informeId:i,intervencionId:t.intervencionId})})]})}function K({componente:s,datos:i,readOnly:o,onFieldChange:x,informeId:t,localDatos:n,onSaved:r}){var a;const c=I(s.id,t),d=!!n&&Object.keys(n).length>0,m=async()=>{var f,p;if(!(!n||!d))try{await c.mutateAsync(n),r()}catch(h){const v=((p=(f=h==null?void 0:h.response)==null?void 0:f.data)==null?void 0:p.error)??"Error al guardar";alert(v)}},b=((a=s.schemaCongelado)==null?void 0:a.blocks)??[];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-medium",children:s.etiqueta}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.componenteSistema.modeloComponente.nombre,s.componenteSistema.numeroSerie&&` · S/N: ${s.componenteSistema.numeroSerie}`]})]}),!o&&e.jsxs(y,{size:"sm",onClick:m,disabled:!d||c.isPending,className:"gap-1",children:[c.isPending?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(z,{className:"h-4 w-4"}),"Guardar"]})]}),e.jsx("div",{className:"flex flex-wrap items-start gap-y-4",children:b.map(f=>e.jsx(V,{block:f,datos:i,readOnly:o,onFieldChange:x},f.id))})]})}const Y=new Set(["header","section_title","divider","tristate","checklist","table"]);function H(s){if(Y.has(s.type))return"w-full";const i=s.config.width||"full";return D[i]||"w-full"}function V({block:s,datos:i,readOnly:o,onFieldChange:x}){const t=P(s.type);if(!t)return null;const n=H(s),r=$[s.config.align||"left"];if(q.has(s.type)){const m=t.EditorPreview;return e.jsx("div",{className:`${n} ${r} pointer-events-none`,children:e.jsx(m,{block:s,isSelected:!1})})}const c=s.config.key;if(!c)return null;const d=t.FormField;if(!d){const m=t.EditorPreview;return e.jsx("div",{className:`${n} ${r} pointer-events-none opacity-70`,children:e.jsx(m,{block:s,isSelected:!1})})}return e.jsx("div",{className:`${n} ${r}`,children:e.jsx(d,{block:s,value:i[c]??null,onChange:m=>x(c,m),readOnly:o})})}function J({informeId:s,intervencionId:i}){const o=k(s,i),x=async()=>{var t,n;if(window.confirm("Una vez finalizado, los datos del informe no se podran modificar. ¿Continuar?"))try{await o.mutateAsync("finalizado")}catch(r){const c=((n=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:n.error)??"Error al finalizar";alert(c)}};return e.jsxs(y,{onClick:x,disabled:o.isPending,variant:"default",className:"gap-1",children:[o.isPending?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(U,{className:"h-4 w-4"}),"Finalizar informe"]})}export{te as default};
