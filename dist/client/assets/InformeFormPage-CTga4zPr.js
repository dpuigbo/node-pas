import{f as I,c as A,u as $,g as B,Q as O,r as p,R as P,j as e,L as w,B as v,A as T,a as E,b as D}from"./index-B0LbJrUt.js";import{a as K,b as R}from"./useInformes-CWKYpmOY.js";import{L as k,g as U,B as q,F as G}from"./index-Te2I3AAu.js";import{C as V}from"./circle-alert-QSt_culn.js";import{E as W}from"./eye-CH9aHuDx.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],H=I("CircleCheck",Q);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],Y=I("Circle",M),J={borrador:"bg-gray-100 text-gray-700",finalizado:"bg-amber-100 text-amber-700",entregado:"bg-green-100 text-green-700"},X={borrador:"Borrador",finalizado:"Finalizado",entregado:"Entregado"},Z=new Set(["header","section_title","divider","section_separator","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","content_placeholder","intervention_data","client_data","component_section"]),ee=new Set(["header","section_title","divider","section_separator","tristate","checklist","table","equipment_exchange","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","intervention_data","client_data"]),ae={portada:"Portada",intermedia:"Contenido",contraportada:"Contraportada"};function me(){var S;const{id:a}=A(),t=Number(a),l=$(),{isAdmin:f}=B(),c=O(),{data:r,isLoading:d,error:n}=K(t||void 0),[i,s]=p.useState({}),[m,j]=p.useState(!1),y=((S=r==null?void 0:r.informe)==null?void 0:S.estado)!=="borrador",g=p.useMemo(()=>Object.values(i).some(o=>o&&Object.keys(o).length>0),[i]),_=p.useMemo(()=>Object.entries(i).filter(([,o])=>o&&Object.keys(o).length>0).map(([o])=>Number(o)),[i]),L=p.useCallback((o,N,x)=>{y||s(h=>({...h,[o]:{...h[o]??{},[N]:x}}))},[y]),F=p.useCallback(async()=>{var o,N;if(!(!g||m)){j(!0);try{const x=_.map(async h=>{const b=i[h];!b||Object.keys(b).length===0||await P.patch(`/v1/componentes-informe/${h}/datos`,{datos:b})});await Promise.all(x),s({}),c.invalidateQueries({queryKey:["informes",t,"assembled"]})}catch(x){const h=((N=(o=x==null?void 0:x.response)==null?void 0:o.data)==null?void 0:N.error)??"Error al guardar";alert(h)}finally{j(!1)}}},[g,m,_,i,c,t]);if(d)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(w,{className:"h-8 w-8 animate-spin text-muted-foreground"})});if(n||!r)return e.jsxs("div",{className:"flex h-screen flex-col items-center justify-center gap-4",children:[e.jsx(V,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:(n==null?void 0:n.message)||"No se pudo cargar el informe"}),e.jsx(v,{variant:"outline",onClick:()=>l(-1),children:"Volver"})]});const{informe:u,assembled:C,documentTemplate:z}=r;return e.jsxs("div",{className:"flex h-screen flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex h-14 items-center justify-between border-b bg-background px-4 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>l(`/intervenciones/${u.intervencion.id}`),title:"Volver a intervencion",children:e.jsx(T,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:u.sistema.nombre}),e.jsx(E,{className:"bg-blue-100 text-blue-800",children:z.nombre}),e.jsx(E,{className:J[u.estado]??"bg-gray-100 text-gray-700",children:X[u.estado]??u.estado}),g&&e.jsxs("span",{className:"text-xs text-amber-600 font-medium",children:[e.jsx(Y,{className:"inline h-2 w-2 fill-amber-500 text-amber-500 mr-1"}),"Sin guardar"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>l(`/informes/${t}/preview`),className:"gap-1",children:[e.jsx(W,{className:"h-4 w-4"}),"Vista previa"]}),!y&&e.jsxs(v,{size:"sm",onClick:F,disabled:!g||m,className:"gap-1",children:[m?e.jsx(w,{className:"h-4 w-4 animate-spin"}):e.jsx(D,{className:"h-4 w-4"}),"Guardar",_.length>0&&` (${_.length})`]}),f&&u.estado==="borrador"&&e.jsx(re,{informeId:t,intervencionId:u.intervencion.id,disabled:g})]})]}),e.jsx("div",{className:"flex-1 overflow-auto bg-gray-100",children:e.jsx("div",{className:"py-8 px-4",children:e.jsx(se,{blocks:C.blocks,pageConfig:C.pageConfig,localDatos:i,readOnly:y,onFieldChange:L})})})]})}function se({blocks:a,pageConfig:t,localDatos:l,readOnly:f,onFieldChange:c}){const r=t.orientation==="landscape",d=r?1123:794,{margins:n}=t;let i;return e.jsx("div",{className:"mx-auto bg-white shadow-lg",style:{width:d,minHeight:r?794:1123,paddingTop:`${n.top}mm`,paddingRight:`${n.right}mm`,paddingBottom:`${n.bottom}mm`,paddingLeft:`${n.left}mm`,fontFamily:t.fontFamily,fontSize:t.fontSize},children:e.jsx("div",{className:"flex flex-wrap items-start",children:a.map(s=>{const m=[];return s._source==="component"&&s._componenteInformeId!==i&&(i=s._componenteInformeId,m.push(e.jsxs("div",{className:"w-full flex items-center gap-2 py-2 px-1 my-1",children:[e.jsx(k,{className:"h-3.5 w-3.5 text-blue-500"}),e.jsx("span",{className:"text-xs font-medium text-blue-600",children:s._componenteEtiqueta}),e.jsx("div",{className:"flex-1 border-t border-blue-200"})]},`comp-sep-${s._componenteInformeId}`))),m.push(e.jsx(te,{block:s,localDatos:l,readOnly:f,onFieldChange:c},s.id)),m})})})}function te({block:a,localDatos:t,readOnly:l,onFieldChange:f}){const c=U(a.type);if(!c)return null;if(a.type==="section_separator"){const s=a.config.section;return e.jsx("div",{className:"w-full my-4",children:e.jsxs("div",{className:"flex items-center gap-2 py-2",children:[e.jsx("div",{className:"flex-1 border-t-2 border-dashed border-gray-300"}),e.jsx("span",{className:"text-xs font-bold text-gray-400 uppercase tracking-wider",children:ae[s]??s}),e.jsx("div",{className:"flex-1 border-t-2 border-dashed border-gray-300"})]})})}const r=ne(a),d=q[a.config.align||"left"];if(Z.has(a.type)){const s=c.EditorPreview;return e.jsx("div",{className:`${r} ${d} pointer-events-none`,children:e.jsx(s,{block:a,isSelected:!1})})}const n=c.FormField;if(n&&a._dataKey&&a._componenteInformeId){const s=t[a._componenteInformeId],m=(s==null?void 0:s[a._dataKey])!==void 0?s[a._dataKey]:a._dataValue??null;return e.jsx("div",{className:`${r} ${d}`,children:e.jsx(n,{block:a,value:m,onChange:j=>f(a._componenteInformeId,a._dataKey,j),readOnly:l})})}const i=c.EditorPreview;return e.jsx("div",{className:`${r} ${d} pointer-events-none`,children:e.jsx(i,{block:a,isSelected:!1})})}function ne(a){if(ee.has(a.type))return"w-full";const t=a.config.width||"full";return G[t]||"w-full"}function re({informeId:a,intervencionId:t,disabled:l}){const f=R(a,t),c=async()=>{var r,d;if(window.confirm("Una vez finalizado, los datos del informe no se podran modificar. Â¿Continuar?"))try{await f.mutateAsync("finalizado")}catch(n){const i=((d=(r=n==null?void 0:n.response)==null?void 0:r.data)==null?void 0:d.error)??"Error al finalizar";alert(i)}};return e.jsxs(v,{onClick:c,disabled:f.isPending||l,variant:"default",className:"gap-1",title:l?"Guarda los cambios antes de finalizar":void 0,children:[f.isPending?e.jsx(w,{className:"h-4 w-4 animate-spin"}):e.jsx(H,{className:"h-4 w-4"}),"Finalizar"]})}export{me as default};
