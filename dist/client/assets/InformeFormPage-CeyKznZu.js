import{f as $,c as U,u as V,g as G,Q as q,r as c,R as O,j as e,L as F,B as b,A as M,a as k,b as Q}from"./index-CXFlX0JT.js";import{a as W,b as Y}from"./useInformes-fzFMouEn.js";import{g as H,B as J,F as X}from"./index-CfT_EmWO.js";import{A as Z,D as ee}from"./AssembledTableOfContents-DFxXsYJp.js";import{C as se}from"./circle-alert-CwjefTFn.js";import{E as ae}from"./eye-_DTIJgD1.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],ne=$("CircleCheck",te);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],ie=$("Circle",re),oe={borrador:"bg-gray-100 text-gray-700",finalizado:"bg-amber-100 text-amber-700",entregado:"bg-green-100 text-green-700"},ce={borrador:"Borrador",finalizado:"Finalizado",entregado:"Entregado"},le=new Set(["header","section_title","divider","section_separator","tristate","checklist","table","equipment_exchange","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","intervention_data","client_data"]),de=new Set(["header","section_title","divider","section_separator","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","content_placeholder","intervention_data","client_data","component_section"]);function ye(){var B,I;const{id:s}=U(),r=Number(s),l=V(),{isAdmin:p}=G(),_=q(),{data:n,isLoading:d,error:i}=W(r||void 0),[t,j]=c.useState({}),[f,h]=c.useState({}),[g,m]=c.useState(!1),u=((B=n==null?void 0:n.informe)==null?void 0:B.estado)!=="borrador",P=c.useMemo(()=>Object.values(t).some(a=>a&&Object.keys(a).length>0),[t]),N=c.useMemo(()=>Object.keys(f).length>0,[f]),C=P||N,w=c.useMemo(()=>Object.entries(t).filter(([,a])=>a&&Object.keys(a).length>0).map(([a])=>Number(a)),[t]),A=c.useCallback((a,y,o)=>{u||j(v=>({...v,[a]:{...v[a]??{},[y]:o}}))},[u]),D=c.useCallback((a,y)=>{u||h(o=>({...o,[a]:y}))},[u]),K=c.useCallback(async()=>{var a,y;if(!(!C||g)){m(!0);try{const o=[];for(const v of w){const E=t[v];!E||Object.keys(E).length===0||o.push(O.patch(`/v1/componentes-informe/${v}/datos`,{datos:E}))}N&&o.push(O.patch(`/v1/informes/${r}/datos-documento`,{datos:f})),await Promise.all(o),j({}),h({}),_.invalidateQueries({queryKey:["informes",r,"assembled"]})}catch(o){const v=((y=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:y.error)??"Error al guardar";alert(v)}finally{m(!1)}}},[C,g,w,t,N,f,_,r]),S=(I=n==null?void 0:n.assembled)==null?void 0:I.blocks,T=c.useCallback(a=>a.type==="table_of_contents"&&S?e.jsx("div",{className:"w-full pointer-events-none",children:e.jsx(Z,{block:a,allBlocks:S})}):e.jsx(me,{block:a,localCompDatos:t,localDocDatos:f,readOnly:u,onCompFieldChange:A,onDocFieldChange:D}),[t,f,u,A,D,S]);if(d)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(F,{className:"h-8 w-8 animate-spin text-muted-foreground"})});if(i||!n)return e.jsxs("div",{className:"flex h-screen flex-col items-center justify-center gap-4",children:[e.jsx(se,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:(i==null?void 0:i.message)||"No se pudo cargar el informe"}),e.jsx(b,{variant:"outline",onClick:()=>l(-1),children:"Volver"})]});const{informe:x,assembled:L,documentTemplate:R}=n,z=w.length+(N?1:0);return e.jsxs("div",{className:"flex h-screen flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex h-14 items-center justify-between border-b bg-background px-4 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>l(`/intervenciones/${x.intervencion.id}`),title:"Volver a intervencion",children:e.jsx(M,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:x.sistema.nombre}),e.jsx(k,{className:"bg-blue-100 text-blue-800",children:R.nombre}),e.jsx(k,{className:oe[x.estado]??"bg-gray-100 text-gray-700",children:ce[x.estado]??x.estado}),C&&e.jsxs("span",{className:"text-xs text-amber-600 font-medium",children:[e.jsx(ie,{className:"inline h-2 w-2 fill-amber-500 text-amber-500 mr-1"}),"Sin guardar"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>l(`/informes/${r}/preview`),className:"gap-1",children:[e.jsx(ae,{className:"h-4 w-4"}),"Vista previa"]}),!u&&e.jsxs(b,{size:"sm",onClick:K,disabled:!C||g,className:"gap-1",children:[g?e.jsx(F,{className:"h-4 w-4 animate-spin"}):e.jsx(Q,{className:"h-4 w-4"}),"Guardar",z>0&&` (${z})`]}),p&&x.estado==="borrador"&&e.jsx(fe,{informeId:r,intervencionId:x.intervencion.id,disabled:C})]})]}),e.jsx("div",{className:"flex-1 overflow-auto bg-gray-100",children:e.jsx("div",{className:"py-8 px-4",children:e.jsx(ee,{blocks:L.blocks,pageConfig:L.pageConfig,renderBlock:T})})})]})}function me({block:s,localCompDatos:r,localDocDatos:l,readOnly:p,onCompFieldChange:_,onDocFieldChange:n}){const d=H(s.type);if(!d)return null;const i=ue(s),t=J[s.config.align||"left"];if(de.has(s.type)){const h=d.EditorPreview;return e.jsx("div",{className:`${i} ${t} pointer-events-none`,children:e.jsx(h,{block:s,isSelected:!1})})}const j=d.FormField;if(j&&s._dataKey){let h,g;if(s._componenteInformeId){const m=r[s._componenteInformeId];h=(m==null?void 0:m[s._dataKey])!==void 0?m[s._dataKey]:s._dataValue??null,g=u=>_(s._componenteInformeId,s._dataKey,u)}else h=l[s._dataKey]!==void 0?l[s._dataKey]:s._dataValue??null,g=m=>n(s._dataKey,m);return e.jsx("div",{className:`${i} ${t}`,children:e.jsx(j,{block:s,value:h,onChange:g,readOnly:p})})}const f=d.EditorPreview;return e.jsx("div",{className:`${i} ${t} pointer-events-none`,children:e.jsx(f,{block:s,isSelected:!1})})}function ue(s){if(le.has(s.type))return"w-full";const r=s.config.width||"full";return X[r]||"w-full"}function fe({informeId:s,intervencionId:r,disabled:l}){const p=Y(s,r),_=async()=>{var n,d;if(window.confirm("Una vez finalizado, los datos del informe no se podran modificar. Â¿Continuar?"))try{await p.mutateAsync("finalizado")}catch(i){const t=((d=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:d.error)??"Error al finalizar";alert(t)}};return e.jsxs(b,{onClick:_,disabled:p.isPending||l,variant:"default",className:"gap-1",title:l?"Guarda los cambios antes de finalizar":void 0,children:[p.isPending?e.jsx(F,{className:"h-4 w-4 animate-spin"}):e.jsx(ne,{className:"h-4 w-4"}),"Finalizar"]})}export{ye as default};
