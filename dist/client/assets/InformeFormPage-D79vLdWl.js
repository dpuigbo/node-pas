import{f as P,c as U,u as V,g as G,Q as q,r as l,R as O,j as e,L as A,B as N,A as M,a as $,b as Q}from"./index-CnoWWkNU.js";import{a as W,b as Y}from"./useInformes-fhzjKZ1D.js";import{g as H,B as J,F as X}from"./index-wLduaGdf.js";import{A as Z,D as ee}from"./AssembledTableOfContents-CT8qV6VH.js";import{C as se}from"./circle-alert-Cb2YO-DF.js";import{E as ae}from"./eye-DhfWb2iY.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],ne=P("CircleCheck",te);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],oe=P("Circle",re),ie={borrador:"bg-gray-100 text-gray-700",finalizado:"bg-amber-100 text-amber-700",entregado:"bg-green-100 text-green-700"},ce={borrador:"Borrador",finalizado:"Finalizado",entregado:"Entregado"},le=new Set(["header","section_title","divider","section_separator","tristate","checklist","table","equipment_exchange","reducer_oils","battery_manipulator","battery_controller","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","intervention_data","client_data"]),de=new Set(["header","section_title","divider","section_separator","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","content_placeholder","component_section"]);function ye(){var I,k;const{id:s}=U(),r=Number(s),d=V(),{isAdmin:g}=G(),v=q(),{data:n,isLoading:m,error:o}=W(r||void 0),[t,w]=l.useState({}),[f,C]=l.useState({}),[_,u]=l.useState(!1),i=((I=n==null?void 0:n.informe)==null?void 0:I.estado)!=="borrador",h=l.useMemo(()=>Object.values(t).some(a=>a&&Object.keys(a).length>0),[t]),y=l.useMemo(()=>Object.keys(f).length>0,[f]),b=h||y,S=l.useMemo(()=>Object.entries(t).filter(([,a])=>a&&Object.keys(a).length>0).map(([a])=>Number(a)),[t]),B=l.useCallback((a,j,c)=>{i||w(p=>({...p,[a]:{...p[a]??{},[j]:c}}))},[i]),D=l.useCallback((a,j)=>{i||C(c=>({...c,[a]:j}))},[i]),K=l.useCallback(async()=>{var a,j;if(!(!b||_)){u(!0);try{const c=[];for(const p of S){const E=t[p];!E||Object.keys(E).length===0||c.push(O.patch(`/v1/componentes-informe/${p}/datos`,{datos:E}))}y&&c.push(O.patch(`/v1/informes/${r}/datos-documento`,{datos:f})),await Promise.all(c),w({}),C({}),v.invalidateQueries({queryKey:["informes",r,"assembled"]})}catch(c){const p=((j=(a=c==null?void 0:c.response)==null?void 0:a.data)==null?void 0:j.error)??"Error al guardar";alert(p)}finally{u(!1)}}},[b,_,S,t,y,f,v,r]),F=(k=n==null?void 0:n.assembled)==null?void 0:k.blocks,T=l.useCallback(a=>a.type==="table_of_contents"&&F?e.jsx("div",{className:"w-full pointer-events-none",children:e.jsx(Z,{block:a,allBlocks:F})}):e.jsx(me,{block:a,localCompDatos:t,localDocDatos:f,readOnly:i,onCompFieldChange:B,onDocFieldChange:D}),[t,f,i,B,D,F]);if(m)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(A,{className:"h-8 w-8 animate-spin text-muted-foreground"})});if(o||!n)return e.jsxs("div",{className:"flex h-screen flex-col items-center justify-center gap-4",children:[e.jsx(se,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:(o==null?void 0:o.message)||"No se pudo cargar el informe"}),e.jsx(N,{variant:"outline",onClick:()=>d(-1),children:"Volver"})]});const{informe:x,assembled:L,documentTemplate:R}=n,z=S.length+(y?1:0);return e.jsxs("div",{className:"flex h-screen flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex h-14 items-center justify-between border-b bg-background px-4 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>d(`/intervenciones/${x.intervencion.id}`),title:"Volver a intervencion",children:e.jsx(M,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:x.sistema.nombre}),e.jsx($,{className:"bg-blue-100 text-blue-800",children:R.nombre}),e.jsx($,{className:ie[x.estado]??"bg-gray-100 text-gray-700",children:ce[x.estado]??x.estado}),b&&e.jsxs("span",{className:"text-xs text-amber-600 font-medium",children:[e.jsx(oe,{className:"inline h-2 w-2 fill-amber-500 text-amber-500 mr-1"}),"Sin guardar"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>d(`/informes/${r}/preview`),className:"gap-1",children:[e.jsx(ae,{className:"h-4 w-4"}),"Vista previa"]}),!i&&e.jsxs(N,{size:"sm",onClick:K,disabled:!b||_,className:"gap-1",children:[_?e.jsx(A,{className:"h-4 w-4 animate-spin"}):e.jsx(Q,{className:"h-4 w-4"}),"Guardar",z>0&&` (${z})`]}),g&&x.estado==="borrador"&&e.jsx(ue,{informeId:r,intervencionId:x.intervencion.id,disabled:b})]})]}),e.jsx("div",{className:"flex-1 overflow-auto bg-gray-100",children:e.jsx("div",{className:"py-8 px-4",children:e.jsx(ee,{blocks:L.blocks,pageConfig:L.pageConfig,renderBlock:T})})})]})}function me({block:s,localCompDatos:r,localDocDatos:d,readOnly:g,onCompFieldChange:v,onDocFieldChange:n}){const m=H(s.type);if(!m)return null;const o=fe(s),t=J[s.config.align||"left"],f=s.type==="back_cover"?"flex-1 flex flex-col":"";if(de.has(s.type)){const u=m.EditorPreview;return e.jsx("div",{className:`${o} ${t} pointer-events-none ${f}`,children:e.jsx(u,{block:s,isSelected:!1})})}const C=m.FormField;if(C&&s._dataKey){let u,i;if(s._componenteInformeId){const h=r[s._componenteInformeId];u=(h==null?void 0:h[s._dataKey])!==void 0?h[s._dataKey]:s._dataValue??null,i=y=>v(s._componenteInformeId,s._dataKey,y)}else u=d[s._dataKey]!==void 0?d[s._dataKey]:s._dataValue??null,i=h=>n(s._dataKey,h);return e.jsx("div",{className:`${o} ${t}`,children:e.jsx(C,{block:s,value:u,onChange:i,readOnly:g})})}const _=m.EditorPreview;return e.jsx("div",{className:`${o} ${t} pointer-events-none`,children:e.jsx(_,{block:s,isSelected:!1})})}function fe(s){if(le.has(s.type))return"w-full";const r=s.config.width||"full";return X[r]||"w-full"}function ue({informeId:s,intervencionId:r,disabled:d}){const g=Y(s,r),v=async()=>{var n,m;if(window.confirm("Una vez finalizado, los datos del informe no se podran modificar. Â¿Continuar?"))try{await g.mutateAsync("finalizado")}catch(o){const t=((m=(n=o==null?void 0:o.response)==null?void 0:n.data)==null?void 0:m.error)??"Error al finalizar";alert(t)}};return e.jsxs(N,{onClick:v,disabled:g.isPending||d,variant:"default",className:"gap-1",title:d?"Guarda los cambios antes de finalizar":void 0,children:[g.isPending?e.jsx(A,{className:"h-4 w-4 animate-spin"}):e.jsx(ne,{className:"h-4 w-4"}),"Finalizar"]})}export{ye as default};
