import{f as K,c as V,u as G,g as q,O as M,r as l,R as $,j as e,L as D,B as b,A as W,a as P,b as Y}from"./index-fgi90ZRw.js";import{a as Q,b as H}from"./useInformes-kEtFXOZ6.js";import{g as J,B as X,F as Z}from"./index-b-Rz7KLD.js";import{A as ee,D as se}from"./AssembledTableOfContents-BNH5HsBQ.js";import{C as ae}from"./circle-alert-D_Yi4r8I.js";import{E as te}from"./eye-BSoW0hne.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],ie=K("CircleCheck",ne);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],re=K("Circle",oe),ce={inactivo:"bg-gray-100 text-gray-700",activo:"bg-blue-100 text-blue-700",finalizado:"bg-green-100 text-green-700"},le={inactivo:"Inactivo",activo:"Activo",finalizado:"Finalizado"},de=new Set(["header","section_title","divider","section_separator","tristate","checklist","table","equipment_exchange","reducer_oils","battery_manipulator","battery_controller","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","intervention_data","client_data"]),me=new Set(["header","section_title","divider","section_separator","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","content_placeholder","component_section"]);function je(){var I,k,O;const{id:s}=V(),i=Number(s),d=G(),{isAdmin:g}=q(),v=M(),{data:t,isLoading:m,error:o}=Q(i||void 0),[n,w]=l.useState({}),[f,C]=l.useState({}),[_,u]=l.useState(!1),r=((I=t==null?void 0:t.informe)==null?void 0:I.estado)==="finalizado"||((k=t==null?void 0:t.informe)==null?void 0:k.estado)==="inactivo",h=l.useMemo(()=>Object.values(n).some(a=>a&&Object.keys(a).length>0),[n]),y=l.useMemo(()=>Object.keys(f).length>0,[f]),N=h||y,S=l.useMemo(()=>Object.entries(n).filter(([,a])=>a&&Object.keys(a).length>0).map(([a])=>Number(a)),[n]),E=l.useCallback((a,j,c)=>{r||w(p=>({...p,[a]:{...p[a]??{},[j]:c}}))},[r]),L=l.useCallback((a,j)=>{r||C(c=>({...c,[a]:j}))},[r]),T=l.useCallback(async()=>{var a,j;if(!(!N||_)){u(!0);try{const c=[];for(const p of S){const A=n[p];!A||Object.keys(A).length===0||c.push($.patch(`/v1/componentes-informe/${p}/datos`,{datos:A}))}y&&c.push($.patch(`/v1/informes/${i}/datos-documento`,{datos:f})),await Promise.all(c),w({}),C({}),v.invalidateQueries({queryKey:["informes",i,"assembled"]})}catch(c){const p=((j=(a=c==null?void 0:c.response)==null?void 0:a.data)==null?void 0:j.error)??"Error al guardar";alert(p)}finally{u(!1)}}},[N,_,S,n,y,f,v,i]),F=(O=t==null?void 0:t.assembled)==null?void 0:O.blocks,R=l.useCallback(a=>a.type==="table_of_contents"&&F?e.jsx("div",{className:"w-full pointer-events-none",children:e.jsx(ee,{block:a,allBlocks:F})}):e.jsx(fe,{block:a,localCompDatos:n,localDocDatos:f,readOnly:r,onCompFieldChange:E,onDocFieldChange:L}),[n,f,r,E,L,F]);if(m)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(D,{className:"h-8 w-8 animate-spin text-muted-foreground"})});if(o||!t)return e.jsxs("div",{className:"flex h-screen flex-col items-center justify-center gap-4",children:[e.jsx(ae,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:(o==null?void 0:o.message)||"No se pudo cargar el informe"}),e.jsx(b,{variant:"outline",onClick:()=>d(-1),children:"Volver"})]});const{informe:x,assembled:z,documentTemplate:U}=t,B=S.length+(y?1:0);return e.jsxs("div",{className:"flex h-screen flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex h-14 items-center justify-between border-b bg-background px-4 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>d(`/intervenciones/${x.intervencion.id}`),title:"Volver a intervencion",children:e.jsx(W,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:x.sistema.nombre}),e.jsx(P,{className:"bg-blue-100 text-blue-800",children:U.nombre}),e.jsx(P,{className:ce[x.estado]??"bg-gray-100 text-gray-700",children:le[x.estado]??x.estado}),N&&e.jsxs("span",{className:"text-xs text-amber-600 font-medium",children:[e.jsx(re,{className:"inline h-2 w-2 fill-amber-500 text-amber-500 mr-1"}),"Sin guardar"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>d(`/informes/${i}/preview`),className:"gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),"Vista previa"]}),!r&&e.jsxs(b,{size:"sm",onClick:T,disabled:!N||_,className:"gap-1",children:[_?e.jsx(D,{className:"h-4 w-4 animate-spin"}):e.jsx(Y,{className:"h-4 w-4"}),"Guardar",B>0&&` (${B})`]}),g&&x.estado==="activo"&&e.jsx(he,{informeId:i,intervencionId:x.intervencion.id,disabled:N})]})]}),e.jsx("div",{className:"flex-1 overflow-auto bg-gray-100",children:e.jsx("div",{className:"py-8 px-4",children:e.jsx(se,{blocks:z.blocks,pageConfig:z.pageConfig,renderBlock:R})})})]})}function fe({block:s,localCompDatos:i,localDocDatos:d,readOnly:g,onCompFieldChange:v,onDocFieldChange:t}){const m=J(s.type);if(!m)return null;const o=ue(s),n=X[s.config.align||"left"],f=s.type==="back_cover"?"flex-1 flex flex-col":"";if(me.has(s.type)){const u=m.EditorPreview;return e.jsx("div",{className:`${o} ${n} pointer-events-none ${f}`,children:e.jsx(u,{block:s,isSelected:!1})})}const C=m.FormField;if(C&&s._dataKey){let u,r;if(s._componenteInformeId){const h=i[s._componenteInformeId];u=(h==null?void 0:h[s._dataKey])!==void 0?h[s._dataKey]:s._dataValue??null,r=y=>v(s._componenteInformeId,s._dataKey,y)}else u=d[s._dataKey]!==void 0?d[s._dataKey]:s._dataValue??null,r=h=>t(s._dataKey,h);return e.jsx("div",{className:`${o} ${n}`,children:e.jsx(C,{block:s,value:u,onChange:r,readOnly:g})})}const _=m.EditorPreview;return e.jsx("div",{className:`${o} ${n} pointer-events-none`,children:e.jsx(_,{block:s,isSelected:!1})})}function ue(s){if(de.has(s.type))return"w-full";const i=s.config.width||"full";return Z[i]||"w-full"}function he({informeId:s,intervencionId:i,disabled:d}){const g=H(s,i),v=async()=>{var t,m;if(window.confirm("Una vez finalizado, los datos del informe no se podran modificar. Â¿Continuar?"))try{await g.mutateAsync("finalizado")}catch(o){const n=((m=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:m.error)??"Error al finalizar";alert(n)}};return e.jsxs(b,{onClick:v,disabled:g.isPending||d,variant:"default",className:"gap-1",title:d?"Guarda los cambios antes de finalizar":void 0,children:[g.isPending?e.jsx(D,{className:"h-4 w-4 animate-spin"}):e.jsx(ie,{className:"h-4 w-4"}),"Finalizar"]})}export{je as default};
