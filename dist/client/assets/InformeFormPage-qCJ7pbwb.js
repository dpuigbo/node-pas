import{f as z,c as B,u as I,g as P,Q as $,r as h,R as O,j as e,L as N,B as j,A as D,a as F,b as K}from"./index-6p6AKDyn.js";import{a as T,b as R}from"./useInformes-BvSm6jd1.js";import{g as U,B as G,F as V}from"./index-B_I_kZhs.js";import{D as q}from"./DocumentPageLayout-kilSMoyd.js";import{C as Q}from"./circle-alert-7ALUcFfl.js";import{E as W}from"./eye-D0yu_nwH.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Y=z("CircleCheck",M);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],J=z("Circle",H),X={borrador:"bg-gray-100 text-gray-700",finalizado:"bg-amber-100 text-amber-700",entregado:"bg-green-100 text-green-700"},Z={borrador:"Borrador",finalizado:"Finalizado",entregado:"Entregado"},ee=new Set(["header","section_title","divider","section_separator","tristate","checklist","table","equipment_exchange","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","intervention_data","client_data"]),ae=new Set(["header","section_title","divider","section_separator","cover_header","page_header","page_footer","back_cover","table_of_contents","page_break","content_placeholder","intervention_data","client_data","component_section"]);function me(){var E;const{id:a}=B(),r=Number(a),l=I(),{isAdmin:m}=P(),o=$(),{data:t,isLoading:d,error:i}=T(r||void 0),[n,c]=h.useState({}),[x,_]=h.useState(!1),p=((E=t==null?void 0:t.informe)==null?void 0:E.estado)!=="borrador",v=h.useMemo(()=>Object.values(n).some(s=>s&&Object.keys(s).length>0),[n]),y=h.useMemo(()=>Object.entries(n).filter(([,s])=>s&&Object.keys(s).length>0).map(([s])=>Number(s)),[n]),w=h.useCallback((s,b,u)=>{p||c(g=>({...g,[s]:{...g[s]??{},[b]:u}}))},[p]),A=h.useCallback(async()=>{var s,b;if(!(!v||x)){_(!0);try{const u=y.map(async g=>{const C=n[g];!C||Object.keys(C).length===0||await O.patch(`/v1/componentes-informe/${g}/datos`,{datos:C})});await Promise.all(u),c({}),o.invalidateQueries({queryKey:["informes",r,"assembled"]})}catch(u){const g=((b=(s=u==null?void 0:u.response)==null?void 0:s.data)==null?void 0:b.error)??"Error al guardar";alert(g)}finally{_(!1)}}},[v,x,y,n,o,r]),L=h.useCallback(s=>e.jsx(se,{block:s,localDatos:n,readOnly:p,onFieldChange:w}),[n,p,w]);if(d)return e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(N,{className:"h-8 w-8 animate-spin text-muted-foreground"})});if(i||!t)return e.jsxs("div",{className:"flex h-screen flex-col items-center justify-center gap-4",children:[e.jsx(Q,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:(i==null?void 0:i.message)||"No se pudo cargar el informe"}),e.jsx(j,{variant:"outline",onClick:()=>l(-1),children:"Volver"})]});const{informe:f,assembled:S,documentTemplate:k}=t;return e.jsxs("div",{className:"flex h-screen flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex h-14 items-center justify-between border-b bg-background px-4 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>l(`/intervenciones/${f.intervencion.id}`),title:"Volver a intervencion",children:e.jsx(D,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:f.sistema.nombre}),e.jsx(F,{className:"bg-blue-100 text-blue-800",children:k.nombre}),e.jsx(F,{className:X[f.estado]??"bg-gray-100 text-gray-700",children:Z[f.estado]??f.estado}),v&&e.jsxs("span",{className:"text-xs text-amber-600 font-medium",children:[e.jsx(J,{className:"inline h-2 w-2 fill-amber-500 text-amber-500 mr-1"}),"Sin guardar"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>l(`/informes/${r}/preview`),className:"gap-1",children:[e.jsx(W,{className:"h-4 w-4"}),"Vista previa"]}),!p&&e.jsxs(j,{size:"sm",onClick:A,disabled:!v||x,className:"gap-1",children:[x?e.jsx(N,{className:"h-4 w-4 animate-spin"}):e.jsx(K,{className:"h-4 w-4"}),"Guardar",y.length>0&&` (${y.length})`]}),m&&f.estado==="borrador"&&e.jsx(ne,{informeId:r,intervencionId:f.intervencion.id,disabled:v})]})]}),e.jsx("div",{className:"flex-1 overflow-auto bg-gray-100",children:e.jsx("div",{className:"py-8 px-4",children:e.jsx(q,{blocks:S.blocks,pageConfig:S.pageConfig,renderBlock:L})})})]})}function se({block:a,localDatos:r,readOnly:l,onFieldChange:m}){const o=U(a.type);if(!o)return null;const t=te(a),d=G[a.config.align||"left"];if(ae.has(a.type)){const c=o.EditorPreview;return e.jsx("div",{className:`${t} ${d} pointer-events-none`,children:e.jsx(c,{block:a,isSelected:!1})})}const i=o.FormField;if(i&&a._dataKey&&a._componenteInformeId){const c=r[a._componenteInformeId],x=(c==null?void 0:c[a._dataKey])!==void 0?c[a._dataKey]:a._dataValue??null;return e.jsx("div",{className:`${t} ${d}`,children:e.jsx(i,{block:a,value:x,onChange:_=>m(a._componenteInformeId,a._dataKey,_),readOnly:l})})}const n=o.EditorPreview;return e.jsx("div",{className:`${t} ${d} pointer-events-none`,children:e.jsx(n,{block:a,isSelected:!1})})}function te(a){if(ee.has(a.type))return"w-full";const r=a.config.width||"full";return V[r]||"w-full"}function ne({informeId:a,intervencionId:r,disabled:l}){const m=R(a,r),o=async()=>{var t,d;if(window.confirm("Una vez finalizado, los datos del informe no se podran modificar. Â¿Continuar?"))try{await m.mutateAsync("finalizado")}catch(i){const n=((d=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:d.error)??"Error al finalizar";alert(n)}};return e.jsxs(j,{onClick:o,disabled:m.isPending||l,variant:"default",className:"gap-1",title:l?"Guarda los cambios antes de finalizar":void 0,children:[m.isPending?e.jsx(N,{className:"h-4 w-4 animate-spin"}):e.jsx(Y,{className:"h-4 w-4"}),"Finalizar"]})}export{me as default};
