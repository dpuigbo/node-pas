import{f as W,G as re,H as M,I as O,J as _,c as oe,u as le,g as ce,K as de,M as me,r as y,j as e,B as u,A as xe,P as ue,a as N,N as U,b as pe,X,C as I,n as D,o as V,O as he,q as H,Q as T,R as je,U as ge,V as fe,W as Ne,F as be,s as ye,Y as ve,t as Ce,v as we,w as Se,x as ke,Z as Te,_ as Ae,$ as Pe,a0 as Ee,a1 as Ie,z as De}from"./index-BQScBO5N.js";import{u as Ve}from"./useInformes-DVqMLFlk.js";import{C as He}from"./circle-alert-lGLOQymB.js";import{E as $e}from"./eye-EeOFtBJl.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],_e=W("Settings2",Fe);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]],q=W("ShoppingCart",ze);function Ge(x){return re({queryKey:["pedido-compra",x],queryFn:async()=>{const{data:l}=await _.get(`/v1/pedidos-compra/intervencion/${x}`);return l},enabled:!!x,retry:!1})}function Le(){const x=M();return O({mutationFn:async l=>{const{data:t}=await _.post(`/v1/pedidos-compra/generar/${l}`);return t},onSuccess:(l,t)=>{x.invalidateQueries({queryKey:["pedido-compra",t]})}})}function Me(){const x=M();return O({mutationFn:async({id:l,estado:t})=>{const{data:d}=await _.patch(`/v1/pedidos-compra/${l}/estado`,{estado:t});return d},onSuccess:()=>{x.invalidateQueries({queryKey:["pedido-compra"]})}})}function Oe(){const x=M();return O({mutationFn:async l=>{await _.delete(`/v1/pedidos-compra/${l}`)},onSuccess:()=>{x.invalidateQueries({queryKey:["pedido-compra"]})}})}const Q=[{value:"1",label:"Lun"},{value:"2",label:"Mar"},{value:"3",label:"Mie"},{value:"4",label:"Jue"},{value:"5",label:"Vie"},{value:"6",label:"Sab"},{value:"7",label:"Dom"}],Ke={inactivo:"bg-gray-100 text-gray-700",activo:"bg-blue-100 text-blue-700",finalizado:"bg-green-100 text-green-700"},Be={inactivo:"Inactivo",activo:"Activo",finalizado:"Finalizado"},Re={preventiva:"bg-blue-100 text-blue-700",correctiva:"bg-orange-100 text-orange-700"},Ue={pendiente:"bg-yellow-100 text-yellow-700",pedido:"bg-blue-100 text-blue-700",recibido:"bg-green-100 text-green-700"},qe={pendiente:"Pendiente",pedido:"Pedido",recibido:"Recibido"},J={1:"N1","2_inferior":"N2 Inf.","2_superior":"N2 Sup.",3:"N3"},Qe={controller:"Controladora",mechanical_unit:"Manipulador",drive_unit:"Drive Unit",external_axis:"Eje Externo"};function Je(x){const l=new Map;for(const t of x){const d=`${t.tipo}-${t.itemId}`,a=l.get(d);a?(a.totalCantidad+=t.cantidad,t.coste!=null&&(a.totalCoste=(a.totalCoste??0)+t.coste*t.cantidad),t.precio!=null&&(a.totalPrecio=(a.totalPrecio??0)+t.precio*t.cantidad),a.detalles.push({sistemaNombre:t.sistemaNombre,componenteTipo:t.componenteTipo,modeloNombre:t.modeloNombre,nivel:t.nivel,cantidad:t.cantidad})):l.set(d,{tipo:t.tipo,itemId:t.itemId,nombre:t.nombre,unidad:t.unidad,totalCantidad:t.cantidad,costeUnitario:t.coste,precioUnitario:t.precio,totalCoste:t.coste!=null?t.coste*t.cantidad:null,totalPrecio:t.precio!=null?t.precio*t.cantidad:null,detalles:[{sistemaNombre:t.sistemaNombre,componenteTipo:t.componenteTipo,modeloNombre:t.modeloNombre,nivel:t.nivel,cantidad:t.cantidad}]})}return Array.from(l.values())}function ss(){var B;const{id:x}=oe(),l=Number(x),t=le(),{isAdmin:d}=ce(),{data:a,isLoading:$}=de(l||void 0),v=Ve(l),h=me(),{data:o,isLoading:C,isError:A}=Ge(l||void 0),b=Le(),P=Me(),w=Oe(),[z,r]=y.useState(!1),[p,E]=y.useState(new Set),[j,G]=y.useState(!1),[i,g]=y.useState({tarifaHoraTrabajo:"",tarifaHoraViaje:"",dietas:"",gestionAccesos:"",horasTrayecto:"",diasViaje:"",km:"",peajes:"",precioHotel:"",precioKm:"",gestionAccesosNueva:!1,numeroTecnicos:"1",viajesIdaVuelta:"1",incluyeConsumibles:!0,horasDia:"",dietasExtra:"",diasTrabajo:"1,2,3,4,5"});y.useEffect(()=>{a&&g({tarifaHoraTrabajo:a.tarifaHoraTrabajo!=null?String(a.tarifaHoraTrabajo):"",tarifaHoraViaje:a.tarifaHoraViaje!=null?String(a.tarifaHoraViaje):"",dietas:a.dietas!=null?String(a.dietas):"",gestionAccesos:a.gestionAccesos!=null?String(a.gestionAccesos):"",horasTrayecto:a.horasTrayecto!=null?String(a.horasTrayecto):"",diasViaje:a.diasViaje!=null?String(a.diasViaje):"",km:a.km!=null?String(a.km):"",peajes:a.peajes!=null?String(a.peajes):"",precioHotel:a.precioHotel!=null?String(a.precioHotel):"",precioKm:a.precioKm!=null?String(a.precioKm):"",gestionAccesosNueva:a.gestionAccesosNueva??!1,numeroTecnicos:String(a.numeroTecnicos??1),viajesIdaVuelta:String(a.viajesIdaVuelta??1),incluyeConsumibles:a.incluyeConsumibles??!0,horasDia:a.horasDia!=null?String(a.horasDia):"",dietasExtra:a.dietasExtra!=null?String(a.dietasExtra):"",diasTrabajo:a.diasTrabajo??"1,2,3,4,5"})},[a]);const Y=async()=>{const s=n=>n.trim()?Number(n):null;await h.mutateAsync({id:l,tarifaHoraTrabajo:s(i.tarifaHoraTrabajo),tarifaHoraViaje:s(i.tarifaHoraViaje),dietas:s(i.dietas),gestionAccesos:s(i.gestionAccesos),horasTrayecto:s(i.horasTrayecto),diasViaje:s(i.diasViaje),km:s(i.km),peajes:s(i.peajes),precioHotel:s(i.precioHotel),precioKm:s(i.precioKm),gestionAccesosNueva:i.gestionAccesosNueva,numeroTecnicos:Number(i.numeroTecnicos)||1,viajesIdaVuelta:Number(i.viajesIdaVuelta)||1,incluyeConsumibles:i.incluyeConsumibles,horasDia:s(i.horasDia),dietasExtra:s(i.dietasExtra),diasTrabajo:i.diasTrabajo}),G(!1)},Z=s=>{const n=i.diasTrabajo.split(",").filter(Boolean),c=n.includes(s)?n.filter(m=>m!==s):[...n,s].sort();g({...i,diasTrabajo:c.join(",")})};if($)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})});if(!a)return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(He,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Intervencion no encontrada"}),e.jsx(u,{variant:"outline",onClick:()=>t("/intervenciones"),children:"Volver a intervenciones"})]});const S=a.informes??[],f=a.sistemas??[],ee=S.length>0&&S.length>=f.length,se=async()=>{var s,n;try{await v.mutateAsync()}catch(c){const m=((n=(s=c==null?void 0:c.response)==null?void 0:s.data)==null?void 0:n.error)??"Error al crear informes";alert(m)}},ae=async()=>{var s,n;try{await b.mutateAsync(l)}catch(c){const m=((n=(s=c==null?void 0:c.response)==null?void 0:s.data)==null?void 0:n.error)??"Error al generar pedido";alert(m)}},te=async()=>{if(o&&confirm("Eliminar el pedido de compra?"))try{await w.mutateAsync(o.id)}catch{alert("Error al eliminar pedido")}},K=async s=>{if(o)try{await P.mutateAsync({id:o.id,estado:s})}catch{alert("Error al cambiar estado")}},ie=s=>{E(n=>{const c=new Set(n);return c.has(s)?c.delete(s):c.add(s),c})},ne=(o==null?void 0:o.lineas)??[],L=Je(ne),k=o&&!A;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(u,{variant:"ghost",size:"icon",onClick:()=>t("/intervenciones"),children:e.jsx(xe,{className:"h-4 w-4"})}),e.jsx(ue,{title:a.titulo,description:`${((B=a.cliente)==null?void 0:B.nombre)??"Sin cliente"}`,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:Re[a.tipo]??"bg-gray-100 text-gray-700",children:a.tipo}),e.jsx(N,{variant:"outline",children:a.estado})]})})]}),a.notas&&e.jsx("p",{className:"text-sm text-muted-foreground",children:a.notas}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(U,{className:"h-5 w-5"})," Configuracion"]}),d&&!j&&e.jsx(u,{variant:"outline",size:"sm",onClick:()=>G(!0),children:"Editar"}),j&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{size:"sm",onClick:Y,disabled:h.isPending,children:[e.jsx(pe,{className:"h-4 w-4 mr-1"}),h.isPending?"Guardando...":"Guardar"]}),e.jsx(u,{variant:"outline",size:"sm",onClick:()=>G(!1),children:e.jsx(X,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(I,{children:[e.jsx(D,{className:"pb-2",children:e.jsxs(V,{className:"text-sm font-medium text-muted-foreground flex items-center gap-1",children:[e.jsx(he,{className:"h-4 w-4"})," Tarifas"]})}),e.jsx(H,{className:"space-y-2",children:[{key:"tarifaHoraTrabajo",label:"€/h trabajo"},{key:"tarifaHoraViaje",label:"€/h desplaz."},{key:"dietas",label:"€ dieta"},{key:"gestionAccesos",label:"€ gest. accesos"}].map(s=>e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:s.label}),j?e.jsx(T,{type:"number",step:"0.01",className:"w-24 h-7 text-right text-xs",value:i[s.key],onChange:n=>g({...i,[s.key]:n.target.value}),placeholder:"0.00"}):e.jsx("span",{className:"text-xs font-mono",children:a[s.key]!=null?`${Number(a[s.key]).toFixed(2)} €`:"-"})]},s.key))})]}),e.jsxs(I,{children:[e.jsx(D,{className:"pb-2",children:e.jsxs(V,{className:"text-sm font-medium text-muted-foreground flex items-center gap-1",children:[e.jsx(je,{className:"h-4 w-4"})," Viaje"]})}),e.jsx(H,{className:"space-y-2",children:[{key:"horasTrayecto",label:"Horas trayecto",suffix:"h"},{key:"diasViaje",label:"Dias viaje",suffix:"d"},{key:"km",label:"KM",suffix:"km"},{key:"peajes",label:"Peajes",suffix:"€"},{key:"precioHotel",label:"Hotel",suffix:"€"},{key:"precioKm",label:"€/km",suffix:"€"}].map(s=>e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:s.label}),j?e.jsx(T,{type:"number",step:"0.01",className:"w-24 h-7 text-right text-xs",value:i[s.key],onChange:n=>g({...i,[s.key]:n.target.value}),placeholder:"0"}):e.jsx("span",{className:"text-xs font-mono",children:a[s.key]!=null?`${Number(a[s.key]).toFixed(2)} ${s.suffix}`:"-"})]},s.key))})]}),e.jsxs(I,{children:[e.jsx(D,{className:"pb-2",children:e.jsxs(V,{className:"text-sm font-medium text-muted-foreground flex items-center gap-1",children:[e.jsx(U,{className:"h-4 w-4"})," Parametros"]})}),e.jsxs(H,{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"N. tecnicos"}),j?e.jsx(T,{type:"number",min:"1",className:"w-24 h-7 text-right text-xs",value:i.numeroTecnicos,onChange:s=>g({...i,numeroTecnicos:s.target.value})}):e.jsx("span",{className:"text-xs font-mono",children:a.numeroTecnicos??1})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Viajes I/V"}),j?e.jsx(T,{type:"number",min:"1",className:"w-24 h-7 text-right text-xs",value:i.viajesIdaVuelta,onChange:s=>g({...i,viajesIdaVuelta:s.target.value})}):e.jsx("span",{className:"text-xs font-mono",children:a.viajesIdaVuelta??1})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Horas/dia"}),j?e.jsx(T,{type:"number",step:"0.5",className:"w-24 h-7 text-right text-xs",value:i.horasDia,onChange:s=>g({...i,horasDia:s.target.value}),placeholder:"8"}):e.jsx("span",{className:"text-xs font-mono",children:a.horasDia!=null?`${Number(a.horasDia)} h`:"-"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Dietas extra"}),j?e.jsx(T,{type:"number",step:"0.01",className:"w-24 h-7 text-right text-xs",value:i.dietasExtra,onChange:s=>g({...i,dietasExtra:s.target.value}),placeholder:"0"}):e.jsx("span",{className:"text-xs font-mono",children:a.dietasExtra!=null?`${Number(a.dietasExtra).toFixed(2)} €`:"-"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Gest. accesos nueva"}),j?e.jsx("input",{type:"checkbox",checked:i.gestionAccesosNueva,onChange:s=>g({...i,gestionAccesosNueva:s.target.checked}),className:"h-4 w-4"}):e.jsx(N,{variant:a.gestionAccesosNueva?"default":"outline",className:"text-xs",children:a.gestionAccesosNueva?"Si":"No"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Consumibles"}),j?e.jsx("input",{type:"checkbox",checked:i.incluyeConsumibles,onChange:s=>g({...i,incluyeConsumibles:s.target.checked}),className:"h-4 w-4"}):e.jsx(N,{variant:a.incluyeConsumibles?"success":"outline",className:"text-xs",children:a.incluyeConsumibles?"Incluidos":"Cliente"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Dias trabajo"}),j?e.jsx("div",{className:"flex flex-wrap gap-1",children:Q.map(s=>{const n=i.diasTrabajo.split(",").includes(s.value);return e.jsx("button",{type:"button",className:`px-2 py-0.5 text-xs rounded border ${n?"bg-primary text-primary-foreground border-primary":"bg-background border-input text-muted-foreground hover:bg-muted"}`,onClick:()=>Z(s.value),children:s.label},s.value)})}):e.jsx("div",{className:"flex flex-wrap gap-1",children:Q.map(s=>{const n=(a.diasTrabajo??"1,2,3,4,5").split(",").includes(s.value);return e.jsx("span",{className:`px-1.5 py-0.5 text-xs rounded ${n?"bg-primary/10 text-primary font-medium":"text-muted-foreground/40"}`,children:s.label},s.value)})})]})]})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(ge,{className:"h-5 w-5"})," Sistemas (",f.length,")"]}),d&&S.length===0&&e.jsxs(u,{variant:"outline",size:"sm",onClick:()=>r(!0),className:"gap-1",children:[e.jsx(_e,{className:"h-4 w-4"}),"Gestionar sistemas"]})]}),f.length===0?e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No hay sistemas asignados a esta intervencion.",d&&' Pulsa "Gestionar sistemas" para asignarlos.']}):e.jsx("div",{className:"grid gap-3 sm:grid-cols-2 lg:grid-cols-3",children:f.map(s=>{var n,c,m,F,R;return e.jsxs(I,{children:[e.jsx(D,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(V,{className:"text-sm font-medium",children:(n=s.sistema)==null?void 0:n.nombre}),e.jsx(N,{variant:"secondary",className:"text-xs",children:J[s.nivel]??s.nivel})]})}),e.jsx(H,{children:e.jsxs("p",{className:"text-xs text-muted-foreground",children:[((m=(c=s.sistema)==null?void 0:c.fabricante)==null?void 0:m.nombre)??""," —"," ",((R=(F=s.sistema)==null?void 0:F.componentes)==null?void 0:R.length)??0," componentes"]})})]},s.sistemaId)})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5"})," Pedido de compra",k&&e.jsx(N,{className:Ue[o.estado]??"bg-gray-100 text-gray-700",children:qe[o.estado]??o.estado})]}),e.jsxs("div",{className:"flex gap-2",children:[d&&!k&&f.length>0&&e.jsxs(u,{onClick:ae,disabled:b.isPending,size:"sm",children:[e.jsx(q,{className:"mr-1 h-4 w-4"}),b.isPending?"Generando...":"Generar pedido"]}),d&&k&&e.jsxs(e.Fragment,{children:[o.estado==="pendiente"&&e.jsx(u,{variant:"outline",size:"sm",onClick:()=>K("pedido"),disabled:P.isPending,children:"Marcar como pedido"}),o.estado==="pedido"&&e.jsx(u,{variant:"outline",size:"sm",onClick:()=>K("recibido"),disabled:P.isPending,children:"Marcar como recibido"}),e.jsx(u,{variant:"ghost",size:"sm",onClick:async()=>{if(confirm("Regenerar el pedido de compra? Se perderan los cambios manuales."))try{await w.mutateAsync(o.id),await b.mutateAsync(l)}catch{alert("Error al regenerar pedido")}},disabled:w.isPending||b.isPending,title:"Regenerar pedido",children:e.jsx(fe,{className:"h-4 w-4"})}),e.jsx(u,{variant:"ghost",size:"sm",onClick:te,disabled:w.isPending,className:"text-destructive hover:text-destructive",title:"Eliminar pedido",children:e.jsx(Ne,{className:"h-4 w-4"})})]})]})]}),C&&!A&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Cargando pedido..."}),!k&&!C&&e.jsx("p",{className:"text-sm text-muted-foreground",children:f.length===0?"Asigna sistemas primero para poder generar el pedido.":d?'Pulsa "Generar pedido" para crear la hoja de pedido de compra basada en los consumibles por nivel.':"No se ha generado un pedido de compra para esta intervencion."}),k&&L.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"No se encontraron consumibles configurados para los sistemas y niveles de esta intervencion."}),k&&L.length>0&&e.jsx("div",{className:"rounded-lg border bg-card overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b bg-muted/50",children:[e.jsx("th",{className:"px-3 py-2 text-left w-8"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Tipo"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Nombre"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Cantidad"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Unidad"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Coste ud."}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Coste total"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Precio ud."}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Precio total"})]})}),e.jsx("tbody",{children:L.map(s=>{const n=`${s.tipo}-${s.itemId}`,c=p.has(n);return e.jsxs(y.Fragment,{children:[e.jsxs("tr",{className:"border-b last:border-0 hover:bg-muted/30 cursor-pointer",onClick:()=>ie(n),children:[e.jsx("td",{className:"px-3 py-2 text-xs text-muted-foreground",children:s.detalles.length>1?c?"▼":"▶":""}),e.jsx("td",{className:"px-3 py-2",children:e.jsx(N,{variant:"outline",className:"text-xs",children:s.tipo==="aceite"?"Aceite":s.tipo==="bateria"?"Bateria":"Consumible"})}),e.jsx("td",{className:"px-3 py-2 font-medium",children:s.nombre}),e.jsx("td",{className:"px-3 py-2 text-right font-mono",children:s.totalCantidad}),e.jsx("td",{className:"px-3 py-2 text-muted-foreground",children:s.unidad??"-"}),e.jsx("td",{className:"px-3 py-2 text-right font-mono",children:s.costeUnitario!=null?`${s.costeUnitario.toFixed(2)} €`:"-"}),e.jsx("td",{className:"px-3 py-2 text-right font-mono",children:s.totalCoste!=null?`${s.totalCoste.toFixed(2)} €`:"-"}),e.jsx("td",{className:"px-3 py-2 text-right font-mono",children:s.precioUnitario!=null?`${s.precioUnitario.toFixed(2)} €`:"-"}),e.jsx("td",{className:"px-3 py-2 text-right font-mono",children:s.totalPrecio!=null?`${s.totalPrecio.toFixed(2)} €`:"-"})]}),c&&s.detalles.map((m,F)=>e.jsxs("tr",{className:"bg-muted/20 border-b last:border-0",children:[e.jsx("td",{className:"px-3 py-1.5"}),e.jsxs("td",{colSpan:2,className:"px-3 py-1.5 text-xs text-muted-foreground",children:[m.sistemaNombre," — ",Qe[m.componenteTipo]??m.componenteTipo," (",m.modeloNombre,") — ",J[m.nivel]??m.nivel]}),e.jsx("td",{className:"px-3 py-1.5 text-right text-xs font-mono",children:m.cantidad}),e.jsx("td",{colSpan:5})]},`${n}-${F}`))]},n)})}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"border-t bg-muted/50 font-medium",children:[e.jsx("td",{colSpan:6,className:"px-3 py-2 text-right",children:"Totales:"}),e.jsx("td",{className:"px-3 py-2 text-right font-mono",children:o.totalCoste!=null?`${Number(o.totalCoste).toFixed(2)} €`:"-"}),e.jsx("td",{className:"px-3 py-2"}),e.jsx("td",{className:"px-3 py-2 text-right font-mono",children:o.totalPrecio!=null?`${Number(o.totalPrecio).toFixed(2)} €`:"-"})]})})]})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5"})," Informes (",S.length,")"]}),d&&!ee&&f.length>0&&e.jsxs(u,{onClick:se,disabled:v.isPending,size:"sm",children:[e.jsx(ye,{className:"mr-1 h-4 w-4"}),v.isPending?"Creando...":"Crear Informes"]})]}),S.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:f.length===0?"Asigna sistemas a la intervencion primero.":d?'Pulsa "Crear Informes" para generar los informes de cada sistema.':"Todavia no se han generado informes."}):e.jsx("div",{className:"grid gap-3 sm:grid-cols-2 lg:grid-cols-3",children:S.map(s=>{var n;return e.jsxs(I,{className:"cursor-pointer transition-shadow hover:shadow-md",onClick:()=>t(`/informes/${s.id}`),children:[e.jsx(D,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(V,{className:"text-sm font-medium truncate",children:((n=s.sistema)==null?void 0:n.nombre)??`Sistema #${s.sistemaId}`}),e.jsx(N,{className:Ke[s.estado]??"bg-gray-100 text-gray-700",children:Be[s.estado]??s.estado})]})}),e.jsx(H,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Clic para abrir y rellenar"}),e.jsxs(u,{variant:"ghost",size:"sm",className:"h-7 px-2 text-xs gap-1",onClick:c=>{c.stopPropagation(),t(`/informes/${s.id}/preview`)},children:[e.jsx($e,{className:"h-3 w-3"}),"Preview"]})]})})]},s.id)})})]}),d&&e.jsx(We,{open:z,onOpenChange:r,intervencion:a,currentSistemaIds:f.map(s=>s.sistemaId),onSave:async s=>{await h.mutateAsync({id:l,sistemaIds:s}),r(!1)},isSaving:h.isPending})]})}function We({open:x,onOpenChange:l,intervencion:t,currentSistemaIds:d,onSave:a,isSaving:$}){const v=t.clienteId,{data:h}=ve(v?{clienteId:v}:void 0),[o,C]=y.useState(d),A=r=>{r&&C(d),l(r)},b=y.useMemo(()=>Array.isArray(h)?h.filter(r=>!o.includes(r.id)):[],[h,o]),P=r=>{C(p=>[...p,r])},w=r=>{C(p=>p.filter(E=>E!==r))},z=r=>{const p=(Array.isArray(h)?h:[]).find(E=>E.id===r);return(p==null?void 0:p.nombre)??`Sistema #${r}`};return e.jsx(Ce,{open:x,onOpenChange:A,children:e.jsxs(we,{className:"max-w-lg",children:[e.jsx(Se,{children:e.jsx(ke,{children:"Gestionar sistemas"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecciona los sistemas del cliente que participan en esta intervencion."}),o.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:o.map(r=>e.jsxs(N,{variant:"secondary",className:"gap-1 pr-1",children:[z(r),e.jsx("button",{type:"button",onClick:()=>w(r),className:"ml-0.5 rounded-full hover:bg-gray-300/50 p-0.5",children:e.jsx(X,{className:"h-3 w-3"})})]},r))}),b.length>0?e.jsxs(Te,{value:"",onValueChange:r=>P(Number(r)),children:[e.jsx(Ae,{children:e.jsx(Pe,{placeholder:"Anadir sistema..."})}),e.jsx(Ee,{children:b.map(r=>{var p;return e.jsxs(Ie,{value:String(r.id),children:[r.nombre,((p=r.fabricante)==null?void 0:p.nombre)&&e.jsxs("span",{className:"text-muted-foreground ml-1",children:["(",r.fabricante.nombre,")"]})]},r.id)})})]}):o.length>0?e.jsx("p",{className:"text-xs text-muted-foreground",children:"Todos los sistemas del cliente han sido asignados."}):e.jsx("p",{className:"text-xs text-muted-foreground",children:"Este cliente no tiene sistemas registrados."})]}),e.jsxs(De,{children:[e.jsx(u,{variant:"outline",onClick:()=>A(!1),children:"Cancelar"}),e.jsx(u,{onClick:()=>a(o),disabled:$,children:$?"Guardando...":"Guardar"})]})]})})}export{ss as default};
