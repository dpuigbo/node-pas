import{f as X,c as me,u as xe,g as ue,h as pe,i as he,k as fe,l as ve,m as je,r as l,n as ge,o as Ne,p as be,j as e,L as T,B as i,A as ye,P as Ce,C as G,q as H,s as q,t as we,v as E,b as R,X as U,w as K,x as ke,a as d,N as Ae,y as Se,F as Ee,z as Pe,D as Le,E as _e,G as ze,H as De,I as Me,J as Oe,T as Ve,K as $e,M as Be,O as J}from"./index-U8pARPr0.js";import{C as Fe}from"./circle-alert-CVCO7Xh9.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]],Te=X("Pause",Ie);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]],He=X("Play",Ge),P={controller:"Controlador",mechanical_unit:"Unidad Mecanica",drive_unit:"Unidad de Accionamiento",external_axis:"Eje Externo"},qe={borrador:"secondary",activo:"default",obsoleto:"outline"},Re={borrador:"Borrador",activo:"Activo",obsoleto:"Obsoleto"};function Je(){var F,I;const{modeloId:Q}=me(),r=Number(Q),m=xe(),{isAdmin:x}=ue(),{data:t,isLoading:W}=pe(r||void 0),{data:Y,isLoading:Z}=he(r||void 0),j=fe(r),L=ve(r),g=je(),[ee,u]=l.useState(!1),[_,z]=l.useState(""),[o,N]=l.useState(null),[se,p]=l.useState(!1),[b,y]=l.useState(!1),[h,D]=l.useState([]),ae=()=>{const s=t!=null&&t.niveles?t.niveles.split(",").filter(Boolean):[],a=t?J(t.tipo):[],n=[...new Set([...a,...s])];D(n),y(!0)},te=s=>{(t?J(t.tipo):[]).includes(s)||D(n=>n.includes(s)?n.filter(de=>de!==s):[...n,s])},ne=async()=>{const s=h.length>0?h.join(","):null;await g.mutateAsync({id:r,niveles:s}),y(!1)},[C,w]=l.useState(!1),[k,M]=l.useState([]),{data:f}=ge(r||void 0),A=Ne(r),O=(t==null?void 0:t.tipo)==="controller"?void 0:"controller",{data:v}=be((F=t==null?void 0:t.fabricante)!=null&&F.id?{fabricanteId:t.fabricante.id,...O?{tipo:O}:{}}:void 0),S=(t==null?void 0:t.tipo)==="controller"?(Array.isArray(v)?v:[]).filter(s=>s.tipo!=="controller"):Array.isArray(v)?v:[],oe=()=>{const s=(f||[]).map(a=>a.id);M(s),w(!0)},V=s=>{M(a=>a.includes(s)?a.filter(n=>n!==s):[...a,s])},ie=async()=>{await A.mutateAsync(k),w(!1)};if(W)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(T,{className:"h-8 w-8 animate-spin text-muted-foreground"})});if(!t)return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(Fe,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Modelo no encontrado"}),e.jsx(i,{variant:"outline",onClick:()=>m(-1),children:"Volver"})]});const $=Y??[],B=t.niveles?t.niveles.split(",").filter(Boolean):[],re=async()=>{const s=await j.mutateAsync({schema:{blocks:[],pageConfig:void 0},notas:_||null});u(!1),z("");const a=(s==null?void 0:s.data)??s;a!=null&&a.id&&m(`/modelos/${r}/versiones/${a.id}/editor`)},le=async()=>{if(!o)return;const s=o.estado==="activo"?"obsoleto":"activo";await L.mutateAsync({id:o.id,estado:s}),p(!1),N(null)},ce=[{key:"version",header:"Version",render:s=>e.jsxs("span",{className:"font-mono font-medium",children:["v",s.version]})},{key:"estado",header:"Estado",render:s=>e.jsx(d,{variant:qe[s.estado]??"outline",children:Re[s.estado]??s.estado})},{key:"bloques",header:"Bloques",render:s=>{var n;const a=((n=s.schema)==null?void 0:n.blocks)??[];return e.jsx(d,{variant:"outline",children:a.length})}},{key:"notas",header:"Notas",render:s=>e.jsx("span",{className:"text-sm text-muted-foreground truncate max-w-[200px] block",children:s.notas||"-"})},{key:"updatedAt",header:"Actualizado",render:s=>{const a=new Date(s.updatedAt);return e.jsx("span",{className:"text-sm text-muted-foreground",children:a.toLocaleDateString("es-ES")})}},{key:"acciones",header:"",render:s=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(i,{variant:"ghost",size:"icon",className:"h-7 w-7",title:"Editar template",onClick:a=>{a.stopPropagation(),m(`/modelos/${r}/versiones/${s.id}/editor`)},children:e.jsx(E,{className:"h-3.5 w-3.5"})}),x&&s.estado!=="activo"&&e.jsx(i,{variant:"ghost",size:"icon",className:"h-7 w-7 text-green-600 hover:text-green-700",title:"Activar version",onClick:a=>{a.stopPropagation(),N(s),p(!0)},children:e.jsx(He,{className:"h-3.5 w-3.5"})}),x&&s.estado==="activo"&&e.jsx(i,{variant:"ghost",size:"icon",className:"h-7 w-7 text-orange-500 hover:text-orange-600",title:"Marcar como obsoleto",onClick:a=>{a.stopPropagation(),N(s),p(!0)},children:e.jsx(Te,{className:"h-3.5 w-3.5"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(i,{variant:"ghost",size:"icon",onClick:()=>m(-1),children:e.jsx(ye,{className:"h-4 w-4"})}),e.jsx(Ce,{title:t.nombre,description:[(I=t.fabricante)==null?void 0:I.nombre,P[t.tipo]??t.tipo].filter(Boolean).join(" â€” ")})]}),t.notas&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t.notas}),e.jsxs(G,{children:[e.jsx(H,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(q,{className:"text-base",children:"Niveles de mantenimiento"}),x&&!b&&we(t.tipo)&&e.jsxs(i,{variant:"outline",size:"sm",onClick:ae,children:[e.jsx(E,{className:"h-3.5 w-3.5 mr-1"})," Editar"]}),b&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(i,{size:"sm",onClick:ne,disabled:g.isPending,children:[e.jsx(R,{className:"h-3.5 w-3.5 mr-1"}),g.isPending?"Guardando...":"Guardar"]}),e.jsx(i,{variant:"outline",size:"sm",onClick:()=>y(!1),children:e.jsx(U,{className:"h-3.5 w-3.5"})})]})]})}),e.jsx(K,{children:b?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Selecciona los niveles de mantenimiento aplicables a este modelo. Los niveles obligatorios no se pueden deseleccionar."}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ke(t.tipo).map(s=>{const a=h.includes(s.value),n=s.fixed;return e.jsx("button",{type:"button",disabled:n,className:`px-3 py-1.5 text-sm rounded-md border transition-colors ${a?n?"bg-primary/70 text-primary-foreground border-primary cursor-not-allowed":"bg-primary text-primary-foreground border-primary":"bg-background border-input text-muted-foreground hover:bg-muted"}`,onClick:()=>te(s.value),children:s.label},s.value)})}),h.length===0&&e.jsx("p",{className:"text-xs text-orange-500",children:"Sin niveles seleccionados. Este modelo no aparecera en ofertas."})]}):e.jsx("div",{className:"flex flex-wrap gap-1.5",children:B.length>0?B.map(s=>e.jsx(d,{variant:"secondary",children:Ae[s]??s},s)):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sin niveles configurados"})})})]}),e.jsxs(G,{children:[e.jsx(H,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(q,{className:"text-base flex items-center gap-2",children:[e.jsx(Se,{className:"h-4 w-4"}),t.tipo==="controller"?"Componentes compatibles":"Controladores compatibles"]}),x&&!C&&e.jsxs(i,{variant:"outline",size:"sm",onClick:oe,children:[e.jsx(E,{className:"h-3.5 w-3.5 mr-1"})," Editar"]}),C&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(i,{size:"sm",onClick:ie,disabled:A.isPending,children:[e.jsx(R,{className:"h-3.5 w-3.5 mr-1"}),A.isPending?"Guardando...":"Guardar"]}),e.jsx(i,{variant:"outline",size:"sm",onClick:()=>w(!1),children:e.jsx(U,{className:"h-3.5 w-3.5"})})]})]})}),e.jsx(K,{children:C?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:t.tipo==="controller"?"Selecciona los componentes compatibles con este controlador.":"Selecciona los controladores compatibles con este componente."}),t.tipo==="controller"?["mechanical_unit","drive_unit","external_axis"].map(s=>{const a=S.filter(n=>n.tipo===s);return a.length===0?null:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground mt-2",children:P[s]??s}),e.jsx("div",{className:"flex flex-wrap gap-2",children:a.map(n=>{const c=k.includes(n.id);return e.jsx("button",{type:"button",className:`px-3 py-1.5 text-sm rounded-md border transition-colors ${c?"bg-primary text-primary-foreground border-primary":"bg-background border-input text-muted-foreground hover:bg-muted"}`,onClick:()=>V(n.id),children:n.nombre},n.id)})})]},s)}):e.jsx("div",{className:"flex flex-wrap gap-2",children:S.map(s=>{const a=k.includes(s.id);return e.jsx("button",{type:"button",className:`px-3 py-1.5 text-sm rounded-md border transition-colors ${a?"bg-primary text-primary-foreground border-primary":"bg-background border-input text-muted-foreground hover:bg-muted"}`,onClick:()=>V(s.id),children:s.nombre},s.id)})}),S.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"No hay modelos candidatos del mismo fabricante."})]}):e.jsx("div",{children:t.tipo==="controller"?(()=>{const s=f??[];return s.length===0?e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sin compatibilidad configurada"}):e.jsx("div",{className:"space-y-2",children:["mechanical_unit","drive_unit","external_axis"].map(a=>{const n=s.filter(c=>c.tipo===a);return n.length===0?null:e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground mb-1",children:P[a]??a}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:n.map(c=>e.jsx(d,{variant:"secondary",children:c.nombre},c.id))})]},a)})})})():e.jsx("div",{className:"flex flex-wrap gap-1.5",children:(f??[]).length>0?f.map(s=>e.jsx(d,{variant:"secondary",children:s.nombre},s.id)):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sin compatibilidad configurada"})})})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(Ee,{className:"h-5 w-5"})," Versiones de Template (",$.length,")"]}),x&&e.jsxs(i,{size:"sm",onClick:()=>u(!0),children:[e.jsx(Pe,{className:"h-4 w-4"})," Nueva version"]})]}),Z?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(T,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):e.jsx(Le,{columns:ce,data:$,emptyMessage:"Sin versiones. Crea una nueva version para empezar a disenar el template.",onRowClick:s=>m(`/modelos/${r}/versiones/${s.id}/editor`),rowKey:s=>s.id})]}),e.jsx(_e,{open:ee,onOpenChange:u,children:e.jsxs(ze,{children:[e.jsx(De,{children:e.jsx(Me,{children:"Nueva version de template"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Se creara una nueva version en estado ",e.jsx(d,{variant:"secondary",children:"Borrador"})," con un template vacio. Podras editarla en el editor visual."]}),e.jsxs("div",{children:[e.jsx(Oe,{children:"Notas (opcional)"}),e.jsx(Ve,{value:_,onChange:s=>z(s.target.value),placeholder:"Ej: Version inicial, correccion de campos...",rows:2})]})]}),e.jsxs($e,{children:[e.jsx(i,{variant:"outline",onClick:()=>u(!1),children:"Cancelar"}),e.jsx(i,{onClick:re,disabled:j.isPending,children:j.isPending?"Creando...":"Crear y abrir editor"})]})]})}),e.jsx(Be,{open:se,onOpenChange:p,title:(o==null?void 0:o.estado)==="activo"?"Marcar como obsoleto":"Activar version",description:(o==null?void 0:o.estado)==="activo"?`La version v${o==null?void 0:o.version} dejara de usarse para nuevos informes.`:`La version v${o==null?void 0:o.version} sera la plantilla activa para nuevos informes. Cualquier otra version activa pasara a obsoleta.`,confirmLabel:(o==null?void 0:o.estado)==="activo"?"Desactivar":"Activar",variant:(o==null?void 0:o.estado)==="activo"?"destructive":"default",onConfirm:le,isLoading:L.isPending})]})}export{Je as default};
