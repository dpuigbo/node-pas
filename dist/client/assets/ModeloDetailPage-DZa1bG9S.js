import{f as q,c as ie,u as re,g as le,h as ce,i as de,k as me,l as xe,m as ue,r as l,n as pe,o as he,j as e,L as F,B as n,A as je,P as ve,C as w,p as k,q as A,t as ge,s as S,b as I,X as G,v as E,w as fe,a as c,N as Ne,F as be,x as ye,D as Ce,y as we,z as ke,E as Ae,G as Se,H as Ee,T as Pe,I as Le,J as ze,K as H}from"./index-BQCB1NuL.js";import{C as De}from"./circle-alert-_w9JaSmR.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]],Be=q("Pause",Ve);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]],Oe=q("Play",Me),_e={controller:"Controlador",mechanical_unit:"Unidad Mecanica",drive_unit:"Unidad de Accionamiento",external_axis:"Eje Externo"},$e={borrador:"secondary",activo:"default",obsoleto:"outline"},Fe={borrador:"Borrador",activo:"Activo",obsoleto:"Obsoleto"};function qe(){var _,$;const{modeloId:R}=ie(),r=Number(R),d=re(),{isAdmin:m}=le(),{data:a,isLoading:U}=ce(r||void 0),{data:T,isLoading:K}=de(r||void 0),h=me(r),P=xe(r),j=ue(),[J,x]=l.useState(!1),[L,z]=l.useState(""),[t,v]=l.useState(null),[X,u]=l.useState(!1),[g,f]=l.useState(!1),[p,D]=l.useState([]),Q=()=>{const s=a!=null&&a.niveles?a.niveles.split(",").filter(Boolean):[],o=a?H(a.tipo):[],i=[...new Set([...o,...s])];D(i),f(!0)},W=s=>{(a?H(a.tipo):[]).includes(s)||D(i=>i.includes(s)?i.filter(ne=>ne!==s):[...i,s])},Y=async()=>{const s=p.length>0?p.join(","):null;await j.mutateAsync({id:r,niveles:s}),f(!1)},{data:V}=pe((_=a==null?void 0:a.fabricante)!=null&&_.id&&(a==null?void 0:a.tipo)!=="controller"?{fabricanteId:a.fabricante.id,tipo:"controller"}:void 0),N=he(),[b,y]=l.useState(!1),[C,B]=l.useState([]),Z=()=>{const s=((a==null?void 0:a.controladoresCompatibles)??[]).map(o=>o.controlador.id);B(s),y(!0)},ee=s=>{B(o=>o.includes(s)?o.filter(i=>i!==s):[...o,s])},se=async()=>{await N.mutateAsync({id:r,controladorIds:C}),y(!1)};if(U)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(F,{className:"h-8 w-8 animate-spin text-muted-foreground"})});if(!a)return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(De,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Modelo no encontrado"}),e.jsx(n,{variant:"outline",onClick:()=>d(-1),children:"Volver"})]});const M=T??[],O=a.niveles?a.niveles.split(",").filter(Boolean):[],ae=async()=>{const s=await h.mutateAsync({schema:{blocks:[],pageConfig:void 0},notas:L||null});x(!1),z("");const o=(s==null?void 0:s.data)??s;o!=null&&o.id&&d(`/modelos/${r}/versiones/${o.id}/editor`)},oe=async()=>{if(!t)return;const s=t.estado==="activo"?"obsoleto":"activo";await P.mutateAsync({id:t.id,estado:s}),u(!1),v(null)},te=[{key:"version",header:"Version",render:s=>e.jsxs("span",{className:"font-mono font-medium",children:["v",s.version]})},{key:"estado",header:"Estado",render:s=>e.jsx(c,{variant:$e[s.estado]??"outline",children:Fe[s.estado]??s.estado})},{key:"bloques",header:"Bloques",render:s=>{var i;const o=((i=s.schema)==null?void 0:i.blocks)??[];return e.jsx(c,{variant:"outline",children:o.length})}},{key:"notas",header:"Notas",render:s=>e.jsx("span",{className:"text-sm text-muted-foreground truncate max-w-[200px] block",children:s.notas||"-"})},{key:"updatedAt",header:"Actualizado",render:s=>{const o=new Date(s.updatedAt);return e.jsx("span",{className:"text-sm text-muted-foreground",children:o.toLocaleDateString("es-ES")})}},{key:"acciones",header:"",render:s=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(n,{variant:"ghost",size:"icon",className:"h-7 w-7",title:"Editar template",onClick:o=>{o.stopPropagation(),d(`/modelos/${r}/versiones/${s.id}/editor`)},children:e.jsx(S,{className:"h-3.5 w-3.5"})}),m&&s.estado!=="activo"&&e.jsx(n,{variant:"ghost",size:"icon",className:"h-7 w-7 text-green-600 hover:text-green-700",title:"Activar version",onClick:o=>{o.stopPropagation(),v(s),u(!0)},children:e.jsx(Oe,{className:"h-3.5 w-3.5"})}),m&&s.estado==="activo"&&e.jsx(n,{variant:"ghost",size:"icon",className:"h-7 w-7 text-orange-500 hover:text-orange-600",title:"Marcar como obsoleto",onClick:o=>{o.stopPropagation(),v(s),u(!0)},children:e.jsx(Be,{className:"h-3.5 w-3.5"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(n,{variant:"ghost",size:"icon",onClick:()=>d(-1),children:e.jsx(je,{className:"h-4 w-4"})}),e.jsx(ve,{title:a.nombre,description:[($=a.fabricante)==null?void 0:$.nombre,_e[a.tipo]??a.tipo].filter(Boolean).join(" â€” ")})]}),a.notas&&e.jsx("p",{className:"text-sm text-muted-foreground",children:a.notas}),e.jsxs(w,{children:[e.jsx(k,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"text-base",children:"Niveles de mantenimiento"}),m&&!g&&ge(a.tipo)&&e.jsxs(n,{variant:"outline",size:"sm",onClick:Q,children:[e.jsx(S,{className:"h-3.5 w-3.5 mr-1"})," Editar"]}),g&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(n,{size:"sm",onClick:Y,disabled:j.isPending,children:[e.jsx(I,{className:"h-3.5 w-3.5 mr-1"}),j.isPending?"Guardando...":"Guardar"]}),e.jsx(n,{variant:"outline",size:"sm",onClick:()=>f(!1),children:e.jsx(G,{className:"h-3.5 w-3.5"})})]})]})}),e.jsx(E,{children:g?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Selecciona los niveles de mantenimiento aplicables a este modelo. Los niveles obligatorios no se pueden deseleccionar."}),e.jsx("div",{className:"flex flex-wrap gap-2",children:fe(a.tipo).map(s=>{const o=p.includes(s.value),i=s.fixed;return e.jsx("button",{type:"button",disabled:i,className:`px-3 py-1.5 text-sm rounded-md border transition-colors ${o?i?"bg-primary/70 text-primary-foreground border-primary cursor-not-allowed":"bg-primary text-primary-foreground border-primary":"bg-background border-input text-muted-foreground hover:bg-muted"}`,onClick:()=>W(s.value),children:s.label},s.value)})}),p.length===0&&e.jsx("p",{className:"text-xs text-orange-500",children:"Sin niveles seleccionados. Este modelo no aparecera en ofertas."})]}):e.jsx("div",{className:"flex flex-wrap gap-1.5",children:O.length>0?O.map(s=>e.jsx(c,{variant:"secondary",children:Ne[s]??s},s)):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sin niveles configurados"})})})]}),a.tipo!=="controller"&&e.jsxs(w,{children:[e.jsx(k,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"text-base",children:"Controladoras asociadas"}),m&&!b&&e.jsxs(n,{variant:"outline",size:"sm",onClick:Z,children:[e.jsx(S,{className:"h-3.5 w-3.5 mr-1"})," Editar"]}),b&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(n,{size:"sm",onClick:se,disabled:N.isPending,children:[e.jsx(I,{className:"h-3.5 w-3.5 mr-1"}),N.isPending?"Guardando...":"Guardar"]}),e.jsx(n,{variant:"outline",size:"sm",onClick:()=>y(!1),children:e.jsx(G,{className:"h-3.5 w-3.5"})})]})]})}),e.jsx(E,{children:b?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Selecciona las controladoras compatibles con este modelo."}),e.jsx("div",{className:"flex flex-wrap gap-2",children:(Array.isArray(V)?V:[]).map(s=>{const o=C.includes(s.id);return e.jsx("button",{type:"button",className:`px-3 py-1.5 text-sm rounded-md border transition-colors ${o?"bg-primary text-primary-foreground border-primary":"bg-background border-input text-muted-foreground hover:bg-muted"}`,onClick:()=>ee(s.id),children:s.nombre},s.id)})}),C.length===0&&e.jsx("p",{className:"text-xs text-orange-500",children:"Sin controladoras seleccionadas. Este componente no aparecera como compatible."})]}):e.jsx("div",{className:"flex flex-wrap gap-1.5",children:(a.controladoresCompatibles??[]).length>0?(a.controladoresCompatibles??[]).map(s=>e.jsx(c,{variant:"secondary",children:s.controlador.nombre},s.controlador.id)):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sin controladoras asociadas"})})})]}),a.tipo==="controller"&&(a.componentesCompatibles??[]).length>0&&e.jsxs(w,{children:[e.jsx(k,{className:"pb-3",children:e.jsx(A,{className:"text-base",children:"Componentes asociados"})}),e.jsx(E,{children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:(a.componentesCompatibles??[]).map(s=>e.jsx(c,{variant:"secondary",children:s.componente.nombre},s.componente.id))})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5"})," Versiones de Template (",M.length,")"]}),m&&e.jsxs(n,{size:"sm",onClick:()=>x(!0),children:[e.jsx(ye,{className:"h-4 w-4"})," Nueva version"]})]}),K?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(F,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):e.jsx(Ce,{columns:te,data:M,emptyMessage:"Sin versiones. Crea una nueva version para empezar a disenar el template.",onRowClick:s=>d(`/modelos/${r}/versiones/${s.id}/editor`),rowKey:s=>s.id})]}),e.jsx(we,{open:J,onOpenChange:x,children:e.jsxs(ke,{children:[e.jsx(Ae,{children:e.jsx(Se,{children:"Nueva version de template"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Se creara una nueva version en estado ",e.jsx(c,{variant:"secondary",children:"Borrador"})," con un template vacio. Podras editarla en el editor visual."]}),e.jsxs("div",{children:[e.jsx(Ee,{children:"Notas (opcional)"}),e.jsx(Pe,{value:L,onChange:s=>z(s.target.value),placeholder:"Ej: Version inicial, correccion de campos...",rows:2})]})]}),e.jsxs(Le,{children:[e.jsx(n,{variant:"outline",onClick:()=>x(!1),children:"Cancelar"}),e.jsx(n,{onClick:ae,disabled:h.isPending,children:h.isPending?"Creando...":"Crear y abrir editor"})]})]})}),e.jsx(ze,{open:X,onOpenChange:u,title:(t==null?void 0:t.estado)==="activo"?"Marcar como obsoleto":"Activar version",description:(t==null?void 0:t.estado)==="activo"?`La version v${t==null?void 0:t.version} dejara de usarse para nuevos informes.`:`La version v${t==null?void 0:t.version} sera la plantilla activa para nuevos informes. Cualquier otra version activa pasara a obsoleta.`,confirmLabel:(t==null?void 0:t.estado)==="activo"?"Desactivar":"Activar",variant:(t==null?void 0:t.estado)==="activo"?"destructive":"default",onConfirm:oe,isLoading:P.isPending})]})}export{qe as default};
