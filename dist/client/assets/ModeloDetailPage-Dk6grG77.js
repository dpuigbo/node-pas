import{f as R,c as ie,u as le,g as ce,h as de,i as me,k as xe,l as ue,m as pe,r as l,n as he,o as je,j as e,L as I,B as r,A as ve,P as ge,C as k,p as A,q as E,t as fe,s as S,b as G,X as H,v as P,w as Ne,a as c,N as be,F as ye,x as Ce,D as we,y as ke,z as Ae,E as Ee,G as Se,H as Pe,T as Le,I as ze,J as De,K as q}from"./index-BGxF-cUI.js";import{C as Ve}from"./circle-alert-BnRm8ivM.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]],Me=R("Pause",Be);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]],_e=R("Play",Oe),$e={controller:"Controlador",mechanical_unit:"Unidad Mecanica",drive_unit:"Unidad de Accionamiento",external_axis:"Eje Externo"},Fe={borrador:"secondary",activo:"default",obsoleto:"outline"},Ie={borrador:"Borrador",activo:"Activo",obsoleto:"Obsoleto"};function qe(){var $,F;const{modeloId:U}=ie(),i=Number(U),d=le(),{isAdmin:m}=ce(),{data:t,isLoading:T}=de(i||void 0),{data:K,isLoading:J}=me(i||void 0),j=xe(i),L=ue(i),v=pe(),[X,u]=l.useState(!1),[z,D]=l.useState(""),[n,g]=l.useState(null),[Q,p]=l.useState(!1),[f,N]=l.useState(!1),[h,V]=l.useState([]),W=()=>{const s=t!=null&&t.niveles?t.niveles.split(",").filter(Boolean):[],o=t?q(t.tipo):[],a=[...new Set([...o,...s])];V(a),N(!0)},Y=s=>{(t?q(t.tipo):[]).includes(s)||V(a=>a.includes(s)?a.filter(re=>re!==s):[...a,s])},Z=async()=>{var s,o;try{const a=h.length>0?h.join(","):null;await v.mutateAsync({id:i,niveles:a}),N(!1)}catch(a){alert(((o=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:o.error)??"Error al guardar niveles")}},{data:B}=he(($=t==null?void 0:t.fabricante)!=null&&$.id&&(t==null?void 0:t.tipo)!=="controller"?{fabricanteId:t.fabricante.id,tipo:"controller"}:void 0),b=je(),[y,C]=l.useState(!1),[w,M]=l.useState([]),ee=()=>{const s=((t==null?void 0:t.controladoresCompatibles)??[]).map(o=>o.controlador.id);M(s),C(!0)},se=s=>{M(o=>o.includes(s)?o.filter(a=>a!==s):[...o,s])},ae=async()=>{var s,o;try{await b.mutateAsync({id:i,controladorIds:w}),C(!1)}catch(a){alert(((o=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:o.error)??"Error al guardar compatibilidad")}};if(T)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(I,{className:"h-8 w-8 animate-spin text-muted-foreground"})});if(!t)return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(Ve,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Modelo no encontrado"}),e.jsx(r,{variant:"outline",onClick:()=>d(-1),children:"Volver"})]});const O=K??[],_=t.niveles?t.niveles.split(",").filter(Boolean):[],te=async()=>{var s,o;try{const a=await j.mutateAsync({schema:{blocks:[],pageConfig:void 0},notas:z||null});u(!1),D("");const x=(a==null?void 0:a.data)??a;x!=null&&x.id&&d(`/modelos/${i}/versiones/${x.id}/editor`)}catch(a){alert(((o=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:o.error)??"Error al crear version")}},oe=async()=>{var s,o;try{if(!n)return;const a=n.estado==="activo"?"obsoleto":"activo";await L.mutateAsync({id:n.id,estado:a}),p(!1),g(null)}catch(a){alert(((o=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:o.error)??"Error al cambiar estado")}},ne=[{key:"version",header:"Version",render:s=>e.jsxs("span",{className:"font-mono font-medium",children:["v",s.version]})},{key:"estado",header:"Estado",render:s=>e.jsx(c,{variant:Fe[s.estado]??"outline",children:Ie[s.estado]??s.estado})},{key:"bloques",header:"Bloques",render:s=>{var a;const o=((a=s.schema)==null?void 0:a.blocks)??[];return e.jsx(c,{variant:"outline",children:o.length})}},{key:"notas",header:"Notas",render:s=>e.jsx("span",{className:"text-sm text-muted-foreground truncate max-w-[200px] block",children:s.notas||"-"})},{key:"updatedAt",header:"Actualizado",render:s=>{const o=new Date(s.updatedAt);return e.jsx("span",{className:"text-sm text-muted-foreground",children:o.toLocaleDateString("es-ES")})}},{key:"acciones",header:"",render:s=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(r,{variant:"ghost",size:"icon",className:"h-7 w-7",title:"Editar template",onClick:o=>{o.stopPropagation(),d(`/modelos/${i}/versiones/${s.id}/editor`)},children:e.jsx(S,{className:"h-3.5 w-3.5"})}),m&&s.estado!=="activo"&&e.jsx(r,{variant:"ghost",size:"icon",className:"h-7 w-7 text-green-600 hover:text-green-700",title:"Activar version",onClick:o=>{o.stopPropagation(),g(s),p(!0)},children:e.jsx(_e,{className:"h-3.5 w-3.5"})}),m&&s.estado==="activo"&&e.jsx(r,{variant:"ghost",size:"icon",className:"h-7 w-7 text-orange-500 hover:text-orange-600",title:"Marcar como obsoleto",onClick:o=>{o.stopPropagation(),g(s),p(!0)},children:e.jsx(Me,{className:"h-3.5 w-3.5"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(r,{variant:"ghost",size:"icon",onClick:()=>d(-1),children:e.jsx(ve,{className:"h-4 w-4"})}),e.jsx(ge,{title:t.nombre,description:[(F=t.fabricante)==null?void 0:F.nombre,$e[t.tipo]??t.tipo,t.familia].filter(Boolean).join(" â€” ")})]}),t.notas&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t.notas}),e.jsxs(k,{children:[e.jsx(A,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(E,{className:"text-base",children:"Niveles de mantenimiento"}),m&&!f&&fe(t.tipo)&&e.jsxs(r,{variant:"outline",size:"sm",onClick:W,children:[e.jsx(S,{className:"h-3.5 w-3.5 mr-1"})," Editar"]}),f&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(r,{size:"sm",onClick:Z,disabled:v.isPending,children:[e.jsx(G,{className:"h-3.5 w-3.5 mr-1"}),v.isPending?"Guardando...":"Guardar"]}),e.jsx(r,{variant:"outline",size:"sm",onClick:()=>N(!1),children:e.jsx(H,{className:"h-3.5 w-3.5"})})]})]})}),e.jsx(P,{children:f?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Selecciona los niveles de mantenimiento aplicables a este modelo. Los niveles obligatorios no se pueden deseleccionar."}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Ne(t.tipo).map(s=>{const o=h.includes(s.value),a=s.fixed;return e.jsx("button",{type:"button",disabled:a,className:`px-3 py-1.5 text-sm rounded-md border transition-colors ${o?a?"bg-primary/70 text-primary-foreground border-primary cursor-not-allowed":"bg-primary text-primary-foreground border-primary":"bg-background border-input text-muted-foreground hover:bg-muted"}`,onClick:()=>Y(s.value),children:s.label},s.value)})}),h.length===0&&e.jsx("p",{className:"text-xs text-orange-500",children:"Sin niveles seleccionados. Este modelo no aparecera en ofertas."})]}):e.jsx("div",{className:"flex flex-wrap gap-1.5",children:_.length>0?_.map(s=>e.jsx(c,{variant:"secondary",children:be[s]??s},s)):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sin niveles configurados"})})})]}),t.tipo!=="controller"&&e.jsxs(k,{children:[e.jsx(A,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(E,{className:"text-base",children:"Controladoras asociadas"}),m&&!y&&e.jsxs(r,{variant:"outline",size:"sm",onClick:ee,children:[e.jsx(S,{className:"h-3.5 w-3.5 mr-1"})," Editar"]}),y&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(r,{size:"sm",onClick:ae,disabled:b.isPending,children:[e.jsx(G,{className:"h-3.5 w-3.5 mr-1"}),b.isPending?"Guardando...":"Guardar"]}),e.jsx(r,{variant:"outline",size:"sm",onClick:()=>C(!1),children:e.jsx(H,{className:"h-3.5 w-3.5"})})]})]})}),e.jsx(P,{children:y?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Selecciona las controladoras compatibles con este modelo."}),e.jsx("div",{className:"flex flex-wrap gap-2",children:(Array.isArray(B)?B:[]).map(s=>{const o=w.includes(s.id);return e.jsx("button",{type:"button",className:`px-3 py-1.5 text-sm rounded-md border transition-colors ${o?"bg-primary text-primary-foreground border-primary":"bg-background border-input text-muted-foreground hover:bg-muted"}`,onClick:()=>se(s.id),children:s.nombre},s.id)})}),w.length===0&&e.jsx("p",{className:"text-xs text-orange-500",children:"Sin controladoras seleccionadas. Este componente no aparecera como compatible."})]}):e.jsx("div",{className:"flex flex-wrap gap-1.5",children:(t.controladoresCompatibles??[]).length>0?(t.controladoresCompatibles??[]).map(s=>e.jsx(c,{variant:"secondary",children:s.controlador.nombre},s.controlador.id)):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sin controladoras asociadas"})})})]}),t.tipo==="controller"&&(t.componentesCompatibles??[]).length>0&&e.jsxs(k,{children:[e.jsx(A,{className:"pb-3",children:e.jsx(E,{className:"text-base",children:"Componentes asociados"})}),e.jsx(P,{children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:(t.componentesCompatibles??[]).map(s=>e.jsx(c,{variant:"secondary",children:s.componente.nombre},s.componente.id))})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5"})," Versiones de Template (",O.length,")"]}),m&&e.jsxs(r,{size:"sm",onClick:()=>u(!0),children:[e.jsx(Ce,{className:"h-4 w-4"})," Nueva version"]})]}),J?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(I,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):e.jsx(we,{columns:ne,data:O,emptyMessage:"Sin versiones. Crea una nueva version para empezar a disenar el template.",onRowClick:s=>d(`/modelos/${i}/versiones/${s.id}/editor`),rowKey:s=>s.id})]}),e.jsx(ke,{open:X,onOpenChange:u,children:e.jsxs(Ae,{children:[e.jsx(Ee,{children:e.jsx(Se,{children:"Nueva version de template"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Se creara una nueva version en estado ",e.jsx(c,{variant:"secondary",children:"Borrador"})," con un template vacio. Podras editarla en el editor visual."]}),e.jsxs("div",{children:[e.jsx(Pe,{children:"Notas (opcional)"}),e.jsx(Le,{value:z,onChange:s=>D(s.target.value),placeholder:"Ej: Version inicial, correccion de campos...",rows:2})]})]}),e.jsxs(ze,{children:[e.jsx(r,{variant:"outline",onClick:()=>u(!1),children:"Cancelar"}),e.jsx(r,{onClick:te,disabled:j.isPending,children:j.isPending?"Creando...":"Crear y abrir editor"})]})]})}),e.jsx(De,{open:Q,onOpenChange:p,title:(n==null?void 0:n.estado)==="activo"?"Marcar como obsoleto":"Activar version",description:(n==null?void 0:n.estado)==="activo"?`La version v${n==null?void 0:n.version} dejara de usarse para nuevos informes.`:`La version v${n==null?void 0:n.version} sera la plantilla activa para nuevos informes. Cualquier otra version activa pasara a obsoleta.`,confirmLabel:(n==null?void 0:n.estado)==="activo"?"Desactivar":"Activar",variant:(n==null?void 0:n.estado)==="activo"?"destructive":"default",onConfirm:oe,isLoading:L.isPending})]})}export{qe as default};
