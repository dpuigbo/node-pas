import{f as I,c as Z,u as ee,g as se,h as ae,i as oe,k as ne,l as te,m as ie,r as l,n as re,j as e,L as N,B as i,A as le,P as ce,C as b,o as y,p as C,t as de,q as O,b as me,X as xe,s as w,v as ue,a as c,N as he,F as pe,w as ve,D as je,x as ge,y as fe,z as Ne,E as be,G as ye,T as Ce,H as we,I as Ae,J as _}from"./index-CPHE6O6D.js";import{C as ke}from"./circle-alert-DycFFy8r.js";/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]],Pe=I("Pause",Se);/**
 * @license lucide-react v0.474.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]],Le=I("Play",Ee),De={controller:"Controlador",mechanical_unit:"Unidad Mecanica",drive_unit:"Unidad de Accionamiento",external_axis:"Eje Externo"},ze={borrador:"secondary",activo:"default",obsoleto:"outline"},Ve={borrador:"Borrador",activo:"Activo",obsoleto:"Obsoleto"};function _e(){var z,V,B,M;const{modeloId:$}=Z(),r=Number($),d=ee(),{isAdmin:m}=se(),{data:a,isLoading:F}=ae(r||void 0),{data:H,isLoading:q}=oe(r||void 0),v=ne(r),A=te(r),x=ie(),[R,u]=l.useState(!1),[k,S]=l.useState(""),[o,j]=l.useState(null),[G,h]=l.useState(!1),[g,f]=l.useState(!1),[p,P]=l.useState([]),T=()=>{const s=a!=null&&a.niveles?a.niveles.split(",").filter(Boolean):[],n=a?_(a.tipo):[],t=[...new Set([...n,...s])];P(t),f(!0)},U=s=>{(a?_(a.tipo):[]).includes(s)||P(t=>t.includes(s)?t.filter(Y=>Y!==s):[...t,s])},J=async()=>{const s=p.length>0?p.join(","):null;await x.mutateAsync({id:r,niveles:s}),f(!1)},{data:E}=re((z=a==null?void 0:a.fabricante)!=null&&z.id&&(a==null?void 0:a.tipo)!=="controller"?{fabricanteId:a.fabricante.id,tipo:"controller"}:void 0),K=async s=>{await x.mutateAsync({id:r,controladorId:s})};if(F)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(N,{className:"h-8 w-8 animate-spin text-muted-foreground"})});if(!a)return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(ke,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Modelo no encontrado"}),e.jsx(i,{variant:"outline",onClick:()=>d(-1),children:"Volver"})]});const L=H??[],D=a.niveles?a.niveles.split(",").filter(Boolean):[],X=async()=>{const s=await v.mutateAsync({schema:{blocks:[],pageConfig:void 0},notas:k||null});u(!1),S("");const n=(s==null?void 0:s.data)??s;n!=null&&n.id&&d(`/modelos/${r}/versiones/${n.id}/editor`)},Q=async()=>{if(!o)return;const s=o.estado==="activo"?"obsoleto":"activo";await A.mutateAsync({id:o.id,estado:s}),h(!1),j(null)},W=[{key:"version",header:"Version",render:s=>e.jsxs("span",{className:"font-mono font-medium",children:["v",s.version]})},{key:"estado",header:"Estado",render:s=>e.jsx(c,{variant:ze[s.estado]??"outline",children:Ve[s.estado]??s.estado})},{key:"bloques",header:"Bloques",render:s=>{var t;const n=((t=s.schema)==null?void 0:t.blocks)??[];return e.jsx(c,{variant:"outline",children:n.length})}},{key:"notas",header:"Notas",render:s=>e.jsx("span",{className:"text-sm text-muted-foreground truncate max-w-[200px] block",children:s.notas||"-"})},{key:"updatedAt",header:"Actualizado",render:s=>{const n=new Date(s.updatedAt);return e.jsx("span",{className:"text-sm text-muted-foreground",children:n.toLocaleDateString("es-ES")})}},{key:"acciones",header:"",render:s=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(i,{variant:"ghost",size:"icon",className:"h-7 w-7",title:"Editar template",onClick:n=>{n.stopPropagation(),d(`/modelos/${r}/versiones/${s.id}/editor`)},children:e.jsx(O,{className:"h-3.5 w-3.5"})}),m&&s.estado!=="activo"&&e.jsx(i,{variant:"ghost",size:"icon",className:"h-7 w-7 text-green-600 hover:text-green-700",title:"Activar version",onClick:n=>{n.stopPropagation(),j(s),h(!0)},children:e.jsx(Le,{className:"h-3.5 w-3.5"})}),m&&s.estado==="activo"&&e.jsx(i,{variant:"ghost",size:"icon",className:"h-7 w-7 text-orange-500 hover:text-orange-600",title:"Marcar como obsoleto",onClick:n=>{n.stopPropagation(),j(s),h(!0)},children:e.jsx(Pe,{className:"h-3.5 w-3.5"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(i,{variant:"ghost",size:"icon",onClick:()=>d(-1),children:e.jsx(le,{className:"h-4 w-4"})}),e.jsx(ce,{title:a.nombre,description:[(V=a.fabricante)==null?void 0:V.nombre,De[a.tipo]??a.tipo].filter(Boolean).join(" â€” ")})]}),a.notas&&e.jsx("p",{className:"text-sm text-muted-foreground",children:a.notas}),e.jsxs(b,{children:[e.jsx(y,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(C,{className:"text-base",children:"Niveles de mantenimiento"}),m&&!g&&de(a.tipo)&&e.jsxs(i,{variant:"outline",size:"sm",onClick:T,children:[e.jsx(O,{className:"h-3.5 w-3.5 mr-1"})," Editar"]}),g&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(i,{size:"sm",onClick:J,disabled:x.isPending,children:[e.jsx(me,{className:"h-3.5 w-3.5 mr-1"}),x.isPending?"Guardando...":"Guardar"]}),e.jsx(i,{variant:"outline",size:"sm",onClick:()=>f(!1),children:e.jsx(xe,{className:"h-3.5 w-3.5"})})]})]})}),e.jsx(w,{children:g?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Selecciona los niveles de mantenimiento aplicables a este modelo. Los niveles obligatorios no se pueden deseleccionar."}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ue(a.tipo).map(s=>{const n=p.includes(s.value),t=s.fixed;return e.jsx("button",{type:"button",disabled:t,className:`px-3 py-1.5 text-sm rounded-md border transition-colors ${n?t?"bg-primary/70 text-primary-foreground border-primary cursor-not-allowed":"bg-primary text-primary-foreground border-primary":"bg-background border-input text-muted-foreground hover:bg-muted"}`,onClick:()=>U(s.value),children:s.label},s.value)})}),p.length===0&&e.jsx("p",{className:"text-xs text-orange-500",children:"Sin niveles seleccionados. Este modelo no aparecera en ofertas."})]}):e.jsx("div",{className:"flex flex-wrap gap-1.5",children:D.length>0?D.map(s=>e.jsx(c,{variant:"secondary",children:he[s]??s},s)):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sin niveles configurados"})})})]}),a.tipo!=="controller"&&e.jsxs(b,{children:[e.jsx(y,{className:"pb-3",children:e.jsx(C,{className:"text-base",children:"Controladora asociada"})}),e.jsx(w,{children:m?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("select",{value:a.controladorId??"",onChange:s=>K(s.target.value?Number(s.target.value):null),className:"flex h-9 w-64 rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-xs focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[e.jsx("option",{value:"",children:"Sin controladora"}),(Array.isArray(E)?E:[]).map(s=>e.jsx("option",{value:s.id,children:s.nombre},s.id))]}),x.isPending&&e.jsx(N,{className:"h-4 w-4 animate-spin text-muted-foreground"})]}):e.jsx(c,{variant:"secondary",children:((B=a.controlador)==null?void 0:B.nombre)??"Sin controladora"})})]}),a.tipo==="controller"&&((M=a.componentesAsociados)==null?void 0:M.length)>0&&e.jsxs(b,{children:[e.jsx(y,{className:"pb-3",children:e.jsx(C,{className:"text-base",children:"Componentes asociados"})}),e.jsx(w,{children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:a.componentesAsociados.map(s=>e.jsx(c,{variant:"secondary",children:s.nombre},s.id))})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5"})," Versiones de Template (",L.length,")"]}),m&&e.jsxs(i,{size:"sm",onClick:()=>u(!0),children:[e.jsx(ve,{className:"h-4 w-4"})," Nueva version"]})]}),q?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(N,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):e.jsx(je,{columns:W,data:L,emptyMessage:"Sin versiones. Crea una nueva version para empezar a disenar el template.",onRowClick:s=>d(`/modelos/${r}/versiones/${s.id}/editor`),rowKey:s=>s.id})]}),e.jsx(ge,{open:R,onOpenChange:u,children:e.jsxs(fe,{children:[e.jsx(Ne,{children:e.jsx(be,{children:"Nueva version de template"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Se creara una nueva version en estado ",e.jsx(c,{variant:"secondary",children:"Borrador"})," con un template vacio. Podras editarla en el editor visual."]}),e.jsxs("div",{children:[e.jsx(ye,{children:"Notas (opcional)"}),e.jsx(Ce,{value:k,onChange:s=>S(s.target.value),placeholder:"Ej: Version inicial, correccion de campos...",rows:2})]})]}),e.jsxs(we,{children:[e.jsx(i,{variant:"outline",onClick:()=>u(!1),children:"Cancelar"}),e.jsx(i,{onClick:X,disabled:v.isPending,children:v.isPending?"Creando...":"Crear y abrir editor"})]})]})}),e.jsx(Ae,{open:G,onOpenChange:h,title:(o==null?void 0:o.estado)==="activo"?"Marcar como obsoleto":"Activar version",description:(o==null?void 0:o.estado)==="activo"?`La version v${o==null?void 0:o.version} dejara de usarse para nuevos informes.`:`La version v${o==null?void 0:o.version} sera la plantilla activa para nuevos informes. Cualquier otra version activa pasara a obsoleta.`,confirmLabel:(o==null?void 0:o.estado)==="activo"?"Desactivar":"Activar",variant:(o==null?void 0:o.estado)==="activo"?"destructive":"default",onConfirm:Q,isLoading:A.isPending})]})}export{_e as default};
