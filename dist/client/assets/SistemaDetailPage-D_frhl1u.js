import{x as S,y,z as E,c as G,u as Y,g as Z,a1 as J,r as N,a2 as W,j as e,B as d,A as X,P as ee,a3 as ne,m as se,D as te,n as ae,o as ie,p as oe,q as re,s as u,Y as P,Z as A,_ as D,$ as T,a0 as x,O as b,t as le,a as O,v as ce,V as de}from"./index-B6ez6gC4.js";import{C as ue}from"./circle-alert-Dxwrh14j.js";function me(i){const o=S();return y({mutationFn:r=>E.post(`/v1/sistemas/${i}/componentes`,r),onSuccess:()=>o.invalidateQueries({queryKey:["sistemas",i]})})}function pe(i){const o=S();return y({mutationFn:({id:r,...h})=>E.put(`/v1/sistemas/${i}/componentes/${r}`,h),onSuccess:()=>o.invalidateQueries({queryKey:["sistemas",i]})})}function xe(i){const o=S();return y({mutationFn:r=>E.delete(`/v1/sistemas/${i}/componentes/${r}`),onSuccess:()=>o.invalidateQueries({queryKey:["sistemas",i]})})}const he={controller:"Controlador",mechanical_unit:"Unidad mecanica",drive_unit:"Unidad de accionamiento",external_axis:"Eje externo"},je=[{value:"1",label:"Nivel 1"},{value:"2_inferior",label:"Nivel 2 Inferior"},{value:"2_superior",label:"Nivel 2 Superior"},{value:"3",label:"Nivel 3"}],ve={1:"N1","2_inferior":"N2 Inf","2_superior":"N2 Sup",3:"N3"};function Ce(){var _,w,I,k;const{id:i}=G(),o=Number(i),r=Y(),{isAdmin:h}=Z(),{data:a,isLoading:$}=J(o||void 0),g=me(o),f=pe(o),B=xe(o),[F,m]=N.useState(!1),[l,q]=N.useState(null),[s,c]=N.useState({tipo:"",modeloComponenteId:0,etiqueta:"",numeroSerie:"",numEjes:"",niveles:["1","2_inferior","2_superior","3"]}),{data:p}=W(a!=null&&a.fabricanteId?{fabricanteId:a.fabricanteId,tipo:s.tipo||void 0}:void 0);if($)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})});if(!a)return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(ue,{className:"h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Sistema no encontrado"}),e.jsx(d,{variant:"outline",onClick:()=>r(-1),children:"Volver"})]});const C=a.componentes??[],j=()=>{c({tipo:"",modeloComponenteId:0,etiqueta:"",numeroSerie:"",numEjes:"",niveles:["1","2_inferior","2_superior","3"]}),q(null)},L=()=>{j(),m(!0)},V=n=>{const t=n.niveles?n.niveles.split(",").filter(Boolean):["1","2_inferior","2_superior","3"];q(n),c({tipo:n.tipo,modeloComponenteId:n.modeloComponenteId,etiqueta:n.etiqueta,numeroSerie:n.numeroSerie||"",numEjes:n.numEjes?String(n.numEjes):"",niveles:t}),m(!0)},M=n=>{c(t=>{const R=t.niveles.includes(n)?t.niveles.filter(H=>H!==n):[...t.niveles,n];return{...t,niveles:R}})},U=async()=>{const n=s.niveles.length>0?s.niveles.join(","):null;l?await f.mutateAsync({id:l.id,etiqueta:s.etiqueta,numeroSerie:s.numeroSerie||null,numEjes:s.numEjes?Number(s.numEjes):null,niveles:n}):await g.mutateAsync({tipo:s.tipo,modeloComponenteId:s.modeloComponenteId,etiqueta:s.etiqueta,numeroSerie:s.numeroSerie||null,numEjes:s.numEjes?Number(s.numEjes):null,niveles:n,orden:C.length}),m(!1),j()},z=async(n,t)=>{window.confirm(`Eliminar componente "${t}"?`)&&await B.mutateAsync(n)},K=[{key:"etiqueta",header:"Etiqueta"},{key:"tipo",header:"Tipo",render:n=>e.jsx(O,{variant:"secondary",children:he[n.tipo]??n.tipo})},{key:"modelo",header:"Modelo",render:n=>{var t;return((t=n.modeloComponente)==null?void 0:t.nombre)??"-"}},{key:"numeroSerie",header:"N/S",render:n=>n.numeroSerie||"-"},{key:"numEjes",header:"Ejes",render:n=>n.numEjes??"-"},{key:"niveles",header:"Niveles",render:n=>{const t=n.niveles?n.niveles.split(",").filter(Boolean):[];return t.length===0?e.jsx("span",{className:"text-muted-foreground text-xs",children:"-"}):e.jsx("div",{className:"flex flex-wrap gap-0.5",children:t.map(v=>e.jsx(O,{variant:"outline",className:"text-[10px] px-1 py-0",children:ve[v]??v},v))})}},...h?[{key:"acciones",header:"",render:n=>e.jsxs("div",{className:"flex gap-0.5",children:[e.jsx(d,{variant:"ghost",size:"icon",className:"h-7 w-7 text-gray-400 hover:text-blue-500",onClick:t=>{t.stopPropagation(),V(n)},children:e.jsx(ce,{className:"h-3.5 w-3.5"})}),e.jsx(d,{variant:"ghost",size:"icon",className:"h-7 w-7 text-gray-400 hover:text-red-500",onClick:t=>{t.stopPropagation(),z(n.id,n.etiqueta)},children:e.jsx(de,{className:"h-3.5 w-3.5"})})]})}]:[]],Q=(l||s.tipo&&s.modeloComponenteId)&&s.etiqueta.trim();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>r(-1),children:e.jsx(X,{className:"h-4 w-4"})}),e.jsx(ee,{title:a.nombre,description:[(_=a.fabricante)==null?void 0:_.nombre,(w=a.planta)==null?void 0:w.nombre,(I=a.maquina)==null?void 0:I.nombre].filter(Boolean).join(" â€” ")})]}),a.descripcion&&e.jsx("p",{className:"text-sm text-muted-foreground",children:a.descripcion}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5"})," Componentes (",C.length,")"]}),h&&e.jsxs(d,{size:"sm",onClick:L,children:[e.jsx(se,{className:"h-4 w-4"})," Componente"]})]}),e.jsx(te,{columns:K,data:C,emptyMessage:"Sin componentes. Anade controladores, unidades mecanicas, etc.",rowKey:n=>n.id})]}),e.jsx(ae,{open:F,onOpenChange:n=>{m(n),n||j()},children:e.jsxs(ie,{className:"max-w-lg",children:[e.jsx(oe,{children:e.jsx(re,{children:l?"Editar componente":"Nuevo componente"})}),e.jsxs("div",{className:"space-y-4",children:[!l&&e.jsxs("div",{children:[e.jsx(u,{children:"Tipo de componente"}),e.jsxs(P,{value:s.tipo,onValueChange:n=>c({...s,tipo:n,modeloComponenteId:0}),children:[e.jsx(A,{children:e.jsx(D,{placeholder:"Seleccionar tipo..."})}),e.jsxs(T,{children:[e.jsx(x,{value:"controller",children:"Controlador"}),e.jsx(x,{value:"mechanical_unit",children:"Unidad mecanica"}),e.jsx(x,{value:"drive_unit",children:"Unidad de accionamiento"}),e.jsx(x,{value:"external_axis",children:"Eje externo"})]})]})]}),!l&&e.jsxs("div",{children:[e.jsx(u,{children:"Modelo"}),s.tipo?e.jsxs(P,{value:String(s.modeloComponenteId||""),onValueChange:n=>c({...s,modeloComponenteId:Number(n)}),children:[e.jsx(A,{children:e.jsx(D,{placeholder:"Seleccionar modelo..."})}),e.jsx(T,{children:(Array.isArray(p)?p:[]).map(n=>e.jsx(x,{value:String(n.id),children:n.nombre},n.id))})]}):e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Selecciona un tipo primero."}),s.tipo&&(p==null?void 0:p.length)===0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["No hay modelos de este tipo para el fabricante ",(k=a.fabricante)==null?void 0:k.nombre,". Crea uno en Catalogos."]})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Etiqueta"}),e.jsx(b,{value:s.etiqueta,onChange:n=>c({...s,etiqueta:n.target.value}),placeholder:"Ej: IRC5 Principal, MU Robot 1..."})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Numero de serie (opcional)"}),e.jsx(b,{value:s.numeroSerie,onChange:n=>c({...s,numeroSerie:n.target.value}),placeholder:"S/N..."})]}),s.tipo==="mechanical_unit"&&e.jsxs("div",{children:[e.jsx(u,{children:"Numero de ejes"}),e.jsx(b,{type:"number",value:s.numEjes,onChange:n=>c({...s,numEjes:n.target.value}),placeholder:"6",min:1})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Niveles de mantenimiento"}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Selecciona los niveles aplicables a este componente."}),e.jsx("div",{className:"flex flex-wrap gap-2",children:je.map(n=>{const t=s.niveles.includes(n.value);return e.jsx("button",{type:"button",className:`px-3 py-1.5 text-sm rounded-md border transition-colors ${t?"bg-primary text-primary-foreground border-primary":"bg-background border-input text-muted-foreground hover:bg-muted"}`,onClick:()=>M(n.value),children:n.label},n.value)})}),s.niveles.length===0&&e.jsx("p",{className:"text-xs text-orange-500 mt-1",children:"Sin niveles seleccionados. Este componente no aparecera en ninguna oferta."})]})]}),e.jsxs(le,{children:[e.jsx(d,{variant:"outline",onClick:()=>{m(!1),j()},children:"Cancelar"}),e.jsx(d,{onClick:U,disabled:!Q||g.isPending||f.isPending,children:g.isPending||f.isPending?l?"Guardando...":"Creando...":l?"Guardar":"Crear"})]})]})})]})}export{Ce as default};
