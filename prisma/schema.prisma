generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ===== AUTH =====

model User {
  id        Int      @id @default(autoincrement())
  microsoftId String @unique @map("microsoft_id")
  email     String   @unique
  nombre    String
  avatar    String?
  rol       Rol      @default(tecnico)
  activo    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  informesCreados Informe[]

  @@map("usuarios")
}

enum Rol {
  admin
  tecnico
}

// ===== JERARQUIA DOMINIO =====

model Cliente {
  id                  Int       @id @default(autoincrement())
  nombre              String
  sede                String?
  direccion           String?
  ciudad              String?
  codigoPostal        String?   @map("codigo_postal")
  provincia           String?
  telefono            String?
  email               String?
  personaContacto     String?   @map("persona_contacto")
  logo                String?   // filename of uploaded logo image
  // Tarifas
  tarifaHoraTrabajo   Decimal?  @map("tarifa_hora_trabajo") @db.Decimal(10, 2)
  tarifaHoraViaje     Decimal?  @map("tarifa_hora_viaje") @db.Decimal(10, 2)
  dietas              Decimal?  @db.Decimal(10, 2)
  gestionAccesos      Decimal?  @map("gestion_accesos") @db.Decimal(10, 2)
  // Logistica viaje
  horasTrayecto       Decimal?  @map("horas_trayecto") @db.Decimal(8, 2)
  diasViaje           Decimal?  @map("dias_viaje") @db.Decimal(8, 2)
  km                  Decimal?  @db.Decimal(10, 2)
  peajes              Decimal?  @db.Decimal(10, 2)
  precioHotel         Decimal?  @map("precio_hotel") @db.Decimal(10, 2)
  precioKm            Decimal?  @map("precio_km") @db.Decimal(10, 2)
  activo              Boolean   @default(true)
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  maquinas       Maquina[]
  sistemas       Sistema[]
  intervenciones Intervencion[]
  ofertas        Oferta[]

  @@map("clientes")
}

model Maquina {
  id          Int      @id @default(autoincrement())
  clienteId   Int      @map("cliente_id")
  nombre      String
  descripcion String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  cliente  Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  sistemas Sistema[]

  @@unique([clienteId, nombre])
  @@map("maquinas")
}

// ===== CATALOGOS =====

model Fabricante {
  id        Int      @id @default(autoincrement())
  nombre    String   @unique
  activo    Boolean  @default(true)
  orden     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  modelos  ModeloComponente[]
  sistemas Sistema[]

  @@map("fabricantes")
}

model ModeloComponente {
  id             Int            @id @default(autoincrement())
  fabricanteId   Int            @map("fabricante_id")
  tipo           TipoComponente
  familia        String?        @db.VarChar(200)
  nombre         String
  notas          String?        @db.Text
  aceitesConfig  Json?          @map("aceites_config")
  niveles        String?        // CSV de niveles aplicables: "1,2,2_inferior,2_superior,3"
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  fabricante               Fabricante                 @relation(fields: [fabricanteId], references: [id], onDelete: Cascade)
  controladoresCompatibles CompatibilidadControlador[] @relation("ComponenteCompat")
  componentesCompatibles   CompatibilidadControlador[] @relation("ControladorCompat")
  versiones                VersionTemplate[]
  componentes              ComponenteSistema[]
  consumiblesNivel         ConsumibleNivel[]

  @@map("modelos_componente")
}

model CompatibilidadControlador {
  controladorId Int @map("controlador_id")
  componenteId  Int @map("componente_id")

  controlador ModeloComponente @relation("ControladorCompat", fields: [controladorId], references: [id], onDelete: Cascade)
  componente  ModeloComponente @relation("ComponenteCompat", fields: [componenteId], references: [id], onDelete: Cascade)

  @@id([controladorId, componenteId])
  @@map("compatibilidad_controlador")
}

enum TipoComponente {
  controller
  mechanical_unit
  drive_unit
  external_axis
}

model VersionTemplate {
  id                 Int            @id @default(autoincrement())
  modeloComponenteId Int            @map("modelo_componente_id")
  version            Int
  estado             EstadoTemplate @default(borrador)
  schema             Json
  notas              String?        @db.Text
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")

  modeloComponente   ModeloComponente  @relation(fields: [modeloComponenteId], references: [id], onDelete: Cascade)
  componentesInforme ComponenteInforme[]

  @@unique([modeloComponenteId, version])
  @@map("versiones_template")
}

enum EstadoTemplate {
  borrador
  activo
  obsoleto
}

// ===== SISTEMAS =====

model Sistema {
  id           Int      @id @default(autoincrement())
  clienteId    Int      @map("cliente_id")
  maquinaId    Int?     @map("maquina_id")
  fabricanteId Int      @map("fabricante_id")
  nombre       String
  descripcion  String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  cliente       Cliente              @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  maquina       Maquina?             @relation(fields: [maquinaId], references: [id], onDelete: SetNull)
  fabricante    Fabricante           @relation(fields: [fabricanteId], references: [id], onDelete: Cascade)
  componentes    ComponenteSistema[]
  intervenciones IntervencionSistema[]
  informes       Informe[]
  ofertas        OfertaSistema[]

  @@unique([clienteId, fabricanteId, nombre])
  @@map("sistemas")
}

model ComponenteSistema {
  id                 Int            @id @default(autoincrement())
  sistemaId          Int            @map("sistema_id")
  modeloComponenteId Int            @map("modelo_componente_id")
  tipo               TipoComponente
  etiqueta           String
  numeroSerie        String?        @map("numero_serie")
  numEjes            Int?           @map("num_ejes")
  metadata           Json?
  orden              Int            @default(0)
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")

  sistema            Sistema          @relation(fields: [sistemaId], references: [id], onDelete: Cascade)
  modeloComponente   ModeloComponente @relation(fields: [modeloComponenteId], references: [id])
  componentesInforme ComponenteInforme[]

  @@map("componentes_sistema")
}

// ===== INTERVENCIONES E INFORMES =====

model Intervencion {
  id          Int                @id @default(autoincrement())
  clienteId   Int                @map("cliente_id")
  ofertaId    Int?               @map("oferta_id")  // FK a oferta origen (cuando exista)
  tipo        TipoIntervencion
  estado      EstadoIntervencion @default(borrador)
  referencia  String?
  titulo      String
  fechaInicio DateTime?          @map("fecha_inicio")
  fechaFin    DateTime?          @map("fecha_fin")
  notas       String?            @db.Text
  // Tarifas (snapshot del cliente, editables)
  tarifaHoraTrabajo   Decimal?   @map("tarifa_hora_trabajo") @db.Decimal(10, 2)
  tarifaHoraViaje     Decimal?   @map("tarifa_hora_viaje") @db.Decimal(10, 2)
  dietas              Decimal?   @db.Decimal(10, 2)
  gestionAccesos      Decimal?   @map("gestion_accesos") @db.Decimal(10, 2)
  // Logistica viaje (snapshot del cliente, editables)
  horasTrayecto       Decimal?   @map("horas_trayecto") @db.Decimal(8, 2)
  diasViaje           Decimal?   @map("dias_viaje") @db.Decimal(8, 2)
  km                  Decimal?   @db.Decimal(10, 2)
  peajes              Decimal?   @db.Decimal(10, 2)
  precioHotel         Decimal?   @map("precio_hotel") @db.Decimal(10, 2)
  precioKm            Decimal?   @map("precio_km") @db.Decimal(10, 2)
  // Campos especificos de intervencion
  gestionAccesosNueva Boolean    @default(false) @map("gestion_accesos_nueva")
  numeroTecnicos      Int        @default(1) @map("numero_tecnicos")
  viajesIdaVuelta     Int        @default(1) @map("viajes_ida_vuelta")
  incluyeConsumibles  Boolean    @default(true) @map("incluye_consumibles")
  horasDia            Decimal?   @map("horas_dia") @db.Decimal(8, 2)
  dietasExtra         Decimal?   @map("dietas_extra") @db.Decimal(10, 2)
  diasTrabajo         String?    @map("dias_trabajo") // JSON: "1,2,3,4,5" (lun-vie)
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  cliente      Cliente              @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  sistemas     IntervencionSistema[]
  informes     Informe[]
  pedidoCompra PedidoCompra?

  @@map("intervenciones")
}

enum TipoIntervencion {
  preventiva
  correctiva
}

enum EstadoIntervencion {
  borrador
  en_curso
  completada
  facturada
}

model IntervencionSistema {
  intervencionId Int    @map("intervencion_id")
  sistemaId      Int    @map("sistema_id")
  nivel          String @default("1")  // '1' | '2_inferior' | '2_superior' | '3'

  intervencion Intervencion @relation(fields: [intervencionId], references: [id], onDelete: Cascade)
  sistema      Sistema      @relation(fields: [sistemaId], references: [id], onDelete: Cascade)

  @@id([intervencionId, sistemaId])
  @@map("intervencion_sistema")
}

model Informe {
  id               Int           @id @default(autoincrement())
  intervencionId   Int           @map("intervencion_id")
  sistemaId        Int           @map("sistema_id")
  estado           EstadoInforme @default(inactivo)
  fechaRealizacion DateTime?     @map("fecha_realizacion")
  notas            String?       @db.Text
  datosDocumento   Json          @default("{}") @map("datos_documento")
  creadoPorId      Int?          @map("creado_por_id")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  intervencion Intervencion      @relation(fields: [intervencionId], references: [id], onDelete: Cascade)
  sistema      Sistema           @relation(fields: [sistemaId], references: [id], onDelete: Cascade)
  creadoPor    User?             @relation(fields: [creadoPorId], references: [id])
  componentes  ComponenteInforme[]

  @@unique([intervencionId, sistemaId])
  @@map("informes")
}

enum EstadoInforme {
  inactivo
  activo
  finalizado
}

model ComponenteInforme {
  id                  Int            @id @default(autoincrement())
  informeId           Int            @map("informe_id")
  componenteSistemaId Int            @map("componente_sistema_id")
  versionTemplateId   Int            @map("version_template_id")
  tipoComponente      TipoComponente @map("tipo_componente")
  etiqueta            String
  orden               Int            @default(0)
  schemaCongelado     Json           @map("schema_congelado")
  datos               Json           @default("{}")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  informe           Informe           @relation(fields: [informeId], references: [id], onDelete: Cascade)
  componenteSistema ComponenteSistema @relation(fields: [componenteSistemaId], references: [id])
  versionTemplate   VersionTemplate   @relation(fields: [versionTemplateId], references: [id])

  @@unique([informeId, componenteSistemaId])
  @@map("componentes_informe")
}

// ===== CATALOGOS ACEITES Y CONSUMIBLES =====

model Aceite {
  id              Int      @id @default(autoincrement())
  nombre          String
  fabricante      String?
  unidad          String?  // unidad de medida: litros, kg, mlâ€¦
  fabricanteRobot String?  @map("fabricante_robot") // CSV de nombres fabricante: "ABB,KUKA"
  coste           Decimal? @db.Decimal(10, 2)
  precio          Decimal? @db.Decimal(10, 2)
  activo          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("aceites")
}

model Consumible {
  id               Int      @id @default(autoincrement())
  nombre           String
  fabricante       String?
  tipo             String   @default("general") // 'general' | 'bateria'
  compatibleCon    String?  @map("compatible_con") // 'mechanical_unit' | 'controller' | null (null=ambos)
  refOriginal      String?  @map("ref_original")      // referencia original del fabricante
  refProveedor     String?  @map("ref_proveedor")      // referencia del proveedor
  denominacion     String?                              // denominacion descriptiva
  fabricanteRobot  String?  @map("fabricante_robot")   // fabricante del robot compatible
  coste            Decimal? @db.Decimal(10, 2)
  precio           Decimal? @db.Decimal(10, 2)
  activo           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("consumibles")
}

// ===== TABLA CONSUMIBLES POR NIVEL (para ofertas/pedidos) =====

model ConsumibleNivel {
  id              Int            @id @default(autoincrement())
  modeloId        Int            @map("modelo_id")
  nivel           String         // '1' | '2_inferior' | '2_superior' | '3'
  horas           Decimal?       @db.Decimal(8, 2)  // horas de trabajo por nivel
  precioOtros     Decimal?       @db.Decimal(10, 2) @map("precio_otros") // precio de otros consumibles
  consumibles     Json?          // [{ tipo: 'aceite'|'bateria'|'consumible', id: number, cantidad: number }]
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  modelo ModeloComponente @relation(fields: [modeloId], references: [id], onDelete: Cascade)

  @@unique([modeloId, nivel])
  @@map("consumibles_nivel")
}

// ===== OFERTAS =====

model Oferta {
  id            Int            @id @default(autoincrement())
  clienteId     Int            @map("cliente_id")
  titulo        String
  referencia    String?
  tipo          TipoIntervencion   // preventiva | correctiva
  estado        String         @default("borrador") // 'borrador' | 'enviada' | 'aprobada' | 'rechazada'
  fechaOferta   DateTime       @default(now()) @map("fecha_oferta")
  validezDias   Int            @default(30) @map("validez_dias")
  notas         String?        @db.Text
  // Totals (auto-calculated)
  totalHoras    Decimal?       @db.Decimal(8, 2) @map("total_horas")
  totalCoste    Decimal?       @db.Decimal(10, 2) @map("total_coste")
  totalPrecio   Decimal?       @db.Decimal(10, 2) @map("total_precio")
  // Planificacion horaria
  fechaInicio       DateTime?  @map("fecha_inicio")
  fechaFin          DateTime?  @map("fecha_fin")
  horaInicioJornada String?    @map("hora_inicio_jornada")  // "08:00"
  horaFinJornada    String?    @map("hora_fin_jornada")     // "20:00"
  diasTrabajo       String?    @map("dias_trabajo")          // "1,2,3,4,5" (lun=1..dom=7)
  // Desglose recargos (auto-calculated)
  desgloseRecargo   Json?      @map("desglose_recargo")
  totalRecargo      Decimal?   @db.Decimal(10, 2) @map("total_recargo")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  cliente  Cliente         @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  sistemas OfertaSistema[]

  @@map("ofertas")
}

model OfertaSistema {
  ofertaId          Int      @map("oferta_id")
  sistemaId         Int      @map("sistema_id")
  nivel             String   @default("1") // '1' | '2_inferior' | '2_superior' | '3'
  // Per-system calculated values
  horas             Decimal? @db.Decimal(8, 2)
  costeConsumibles  Decimal? @db.Decimal(10, 2) @map("coste_consumibles")
  precioConsumibles Decimal? @db.Decimal(10, 2) @map("precio_consumibles")

  oferta  Oferta  @relation(fields: [ofertaId], references: [id], onDelete: Cascade)
  sistema Sistema @relation(fields: [sistemaId], references: [id], onDelete: Cascade)

  @@id([ofertaId, sistemaId])
  @@map("oferta_sistema")
}

// ===== PEDIDOS DE COMPRA =====

model PedidoCompra {
  id              Int      @id @default(autoincrement())
  intervencionId  Int      @unique @map("intervencion_id")
  estado          String   @default("pendiente") // 'pendiente' | 'pedido' | 'recibido'
  notas           String?  @db.Text
  lineas          Json     // [{tipo, itemId, nombre, cantidad, unidad, coste, precio, sistemaId, sistemaNombre, componenteTipo, modeloNombre, nivel}]
  totalCoste      Decimal? @db.Decimal(10, 2) @map("total_coste")
  totalPrecio     Decimal? @db.Decimal(10, 2) @map("total_precio")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  intervencion Intervencion @relation(fields: [intervencionId], references: [id], onDelete: Cascade)

  @@map("pedidos_compra")
}

// ===== PLANTILLAS DE DOCUMENTO =====

model DocumentTemplate {
  id        Int      @id @default(autoincrement())
  tipo      String   @unique  // 'preventivo' | 'correctivo'
  nombre    String
  schema    Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("document_templates")
}

// ===== CONFIGURACION APP =====

model ConfiguracionApp {
  id        Int      @id @default(autoincrement())
  clave     String   @unique
  valor     String   @db.Text
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("configuracion_app")
}
